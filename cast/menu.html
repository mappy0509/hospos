<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>HOSPOS - Menu</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* ãƒ¡ãƒ‹ãƒ¥ãƒ¼ç”»é¢å°‚ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
        body { background-color: #f8f9fa; padding-bottom: 100px; } /* ã‚«ãƒ¼ãƒˆãƒœã‚¿ãƒ³ç”¨ã®ä½™ç™½ */
        
        .page-header {
            background: white;
            padding: 15px 20px;
            position: sticky;
            top: 0;
            z-index: 20;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            display: flex;
            align-items: center;
            gap: 15px;
        }
        .back-btn { background: none; border: none; font-size: 1.2rem; color: var(--text-main); cursor: pointer; }
        .header-info { flex: 1; }
        .header-table { font-weight: bold; font-size: 1.1rem; }
        .header-total { font-size: 0.8rem; color: var(--text-sub); }

        /* ã‚«ãƒ†ã‚´ãƒªãƒãƒ¼ (æ¨ªã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«) */
        .category-bar {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid var(--border-color);
            white-space: nowrap;
            position: sticky;
            top: 60px; /* ãƒ˜ãƒƒãƒ€ãƒ¼ã®ä¸‹ */
            z-index: 19;
            /* ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ãƒãƒ¼ã‚’éš ã™ */
            -ms-overflow-style: none; 
            scrollbar-width: none;
        }
        .category-bar::-webkit-scrollbar { display: none; }

        .cat-pill {
            padding: 8px 16px;
            border-radius: 20px;
            background: #f1f3f5;
            color: var(--text-sub);
            font-size: 0.9rem;
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
        }
        .cat-pill.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 2px 8px rgba(0,123,255,0.3);
        }

        /* å•†å“ãƒªã‚¹ãƒˆ */
        .product-list { padding: 20px; }
        .product-card {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
            box-shadow: var(--shadow-sm);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .prod-info { flex: 1; }
        .prod-name { font-weight: bold; margin-bottom: 4px; }
        .prod-price { color: var(--text-sub); font-size: 0.9rem; }
        .prod-tag {
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 4px;
            background: #fff0f6;
            color: #c026d3; /* ãƒ”ãƒ³ã‚¯ */
            margin-left: 5px;
            font-weight: bold;
        }

        /* æ•°é‡æ“ä½œ */
        .qty-control {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 8px;
        }
        .qty-btn {
            width: 30px; height: 30px;
            border: none; background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            font-weight: bold;
            color: var(--primary-color);
            cursor: pointer;
        }
        .qty-val { font-weight: bold; min-width: 20px; text-align: center; }
        .qty-val.hidden { opacity: 0.3; }

        /* ã‚«ãƒ¼ãƒˆãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ */
        .cart-fab {
            position: fixed;
            bottom: 20px;
            left: 5%;
            width: 90%;
            background: var(--primary-color);
            color: white;
            padding: 15px;
            border-radius: 50px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 5px 20px rgba(0,123,255,0.4);
            cursor: pointer;
            z-index: 100;
            transition: transform 0.2s;
        }
        .cart-fab:active { transform: scale(0.98); }
        .cart-badge {
            background: white;
            color: var(--primary-color);
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: bold;
            font-size: 0.9rem;
        }

        /* æ³¨æ–‡ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay {
            display: none;
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            justify-content: center;
            align-items: flex-end;
        }
        .modal-sheet {
            background: white;
            width: 100%;
            border-radius: 20px 20px 0 0;
            padding: 25px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .cart-item {
            display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px solid #eee;
        }

        /* ãƒ†ã‚¹ãƒˆç”¨ãƒœã‚¿ãƒ³ */
        .demo-btn {
            display: block; width: 100%; padding: 10px; 
            background: #6c757d; color: white; text-align: center; 
            margin-top: 20px; border-radius: 8px; text-decoration: none;
        }
    </style>
</head>
<body>

    <div class="page-header">
        <button class="back-btn" onclick="history.back()"><i class="fas fa-arrow-left"></i></button>
        <div class="header-info">
            <div class="header-table">å“ <span id="table-name">Loading...</span></div>
            <div class="header-total">ç¾åœ¨ã®ç·é¡: <span id="current-total">Â¥0</span></div>
        </div>
    </div>

    <div class="category-bar" id="category-container">
        <div class="cat-pill active">All</div>
        </div>

    <div class="product-list" id="product-container">
        <div style="text-align:center; padding:20px;">èª­ã¿è¾¼ã¿ä¸­...</div>
    </div>

    <div style="padding: 0 20px;">
        <button id="create-demo-products" class="demo-btn">ğŸ› ï¸ ãƒ†ã‚¹ãƒˆç”¨å•†å“ã‚’ä¸€æ‹¬ç™»éŒ²ã™ã‚‹</button>
    </div>

    <div class="cart-fab" id="cart-btn" style="display:none;">
        <span style="font-weight:bold;">æ³¨æ–‡å†…å®¹ã‚’ç¢ºèª</span>
        <div>
            <span id="cart-total-price" style="margin-right:10px;">Â¥0</span>
            <span class="cart-badge" id="cart-count">0</span>
        </div>
    </div>

    <div id="cart-modal" class="modal-overlay">
        <div class="modal-sheet">
            <h3 style="margin-bottom:20px;">æ³¨æ–‡ç¢ºèª</h3>
            <div id="cart-items-list"></div>
            <hr style="margin:20px 0; border:0; border-top:1px dashed #ccc;">
            <div style="display:flex; justify-content:space-between; font-weight:bold; font-size:1.2rem; margin-bottom:20px;">
                <span>åˆè¨ˆ</span>
                <span id="modal-total">Â¥0</span>
            </div>
            <button id="confirm-order-btn" class="btn-primary">æ³¨æ–‡ã‚’ç¢ºå®šã™ã‚‹</button>
            <button id="close-cart" style="width:100%; padding:15px; border:none; background:white; color:#666; margin-top:10px;">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script type="module">
        import { db } from '../assets/js/firebase-config.js';
        import { doc, getDoc, collection, getDocs, addDoc, updateDoc, serverTimestamp, increment, writeBatch } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        const params = new URLSearchParams(window.location.search);
        const slipId = params.get('slipId');
        const tenantId = sessionStorage.getItem('hospos_tenantId');
        const myUid = sessionStorage.getItem('hospos_uid');

        if (!tenantId || !slipId) {
            alert("ã‚¨ãƒ©ãƒ¼: ä¼ç¥¨æƒ…å ±ãŒä¸è¶³ã—ã¦ã„ã¾ã™");
            window.location.href = "order.html";
        }

        const tableDisplay = document.getElementById('table-name');
        const totalDisplay = document.getElementById('current-total');
        const productContainer = document.getElementById('product-container');
        const catContainer = document.getElementById('category-container');
        
        // ã‚«ãƒ¼ãƒˆé–¢é€£
        const cartBtn = document.getElementById('cart-btn');
        const cartCount = document.getElementById('cart-count');
        const cartTotal = document.getElementById('cart-total-price');
        const cartModal = document.getElementById('cart-modal');
        const cartList = document.getElementById('cart-items-list');
        
        let products = [];
        let cart = {}; // { productId: { name, price, qty, isCall } }
        let slipData = null;

        // 1. ä¼ç¥¨æƒ…å ±ã®å–å¾—
        async function loadSlip() {
            const slipRef = doc(db, "tenants", tenantId, "slips", slipId);
            const snap = await getDoc(slipRef);
            if (snap.exists()) {
                slipData = snap.data();
                tableDisplay.textContent = slipData.tableId;
                totalDisplay.textContent = `Â¥${slipData.totalAmount.toLocaleString()}`;
            }
        }

        // 2. å•†å“æƒ…å ±ã®å–å¾—
        async function loadProducts() {
            const q = collection(db, "tenants", tenantId, "products");
            const snap = await getDocs(q);
            
            products = [];
            const categories = new Set();

            snap.forEach(doc => {
                const p = doc.data();
                p.id = doc.id;
                products.push(p);
                if(p.category) categories.add(p.category);
            });

            renderCategories(Array.from(categories));
            renderProducts("All");
        }

        // 3. ã‚«ãƒ†ã‚´ãƒªæç”»
        function renderCategories(cats) {
            // 'All' ä»¥å¤–ã‚’ä¸€æ—¦ã‚¯ãƒªã‚¢ã—ãŸã„ãŒã€HTMLã«ç›´æ›¸ãã—ã¦ã‚‹ã®ã§è¿½åŠ ã™ã‚‹å½¢
            const existing = catContainer.querySelectorAll('.cat-pill:not(:first-child)');
            existing.forEach(e => e.remove());

            cats.forEach(cat => {
                const pill = document.createElement('div');
                pill.className = "cat-pill";
                pill.textContent = cat;
                pill.onclick = () => {
                    document.querySelectorAll('.cat-pill').forEach(p => p.classList.remove('active'));
                    pill.classList.add('active');
                    renderProducts(cat);
                };
                catContainer.appendChild(pill);
            });
            
            // Allãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
            catContainer.firstElementChild.onclick = () => {
                document.querySelectorAll('.cat-pill').forEach(p => p.classList.remove('active'));
                catContainer.firstElementChild.classList.add('active');
                renderProducts("All");
            };
        }

        // 4. å•†å“ãƒªã‚¹ãƒˆæç”»
        function renderProducts(filterCat) {
            productContainer.innerHTML = "";
            const filtered = filterCat === "All" ? products : products.filter(p => p.category === filterCat);

            if (filtered.length === 0) {
                productContainer.innerHTML = "<p style='text-align:center; color:#999;'>å•†å“ãŒã‚ã‚Šã¾ã›ã‚“</p>";
                return;
            }

            filtered.forEach(p => {
                const qty = cart[p.id]?.qty || 0;
                
                const div = document.createElement('div');
                div.className = "product-card";
                div.innerHTML = `
                    <div class="prod-info">
                        <div class="prod-name">
                            ${p.name}
                            ${p.isCallTarget ? '<span class="prod-tag">ã‚³ãƒ¼ãƒ«å¯¾è±¡</span>' : ''}
                        </div>
                        <div class="prod-price">Â¥${p.price.toLocaleString()}</div>
                    </div>
                    <div class="qty-control">
                        <button class="qty-btn" onclick="updateCart('${p.id}', -1)">-</button>
                        <span class="qty-val ${qty > 0 ? '' : 'hidden'}" id="qty-${p.id}">${qty}</span>
                        <button class="qty-btn" onclick="updateCart('${p.id}', 1)">+</button>
                    </div>
                `;
                productContainer.appendChild(div);
            });
        }

        // 5. ã‚«ãƒ¼ãƒˆæ“ä½œ (Globalé–¢æ•°åŒ–)
        window.updateCart = (pid, change) => {
            const product = products.find(p => p.id === pid);
            if (!cart[pid]) cart[pid] = { ...product, qty: 0 };
            
            cart[pid].qty += change;
            if (cart[pid].qty < 0) cart[pid].qty = 0;

            // UIæ›´æ–°
            const qtyEl = document.getElementById(`qty-${pid}`);
            if (qtyEl) {
                qtyEl.textContent = cart[pid].qty;
                qtyEl.classList.toggle('hidden', cart[pid].qty === 0);
            }

            if (cart[pid].qty === 0) delete cart[pid];
            updateCartButton();
        };

        function updateCartButton() {
            const totalQty = Object.values(cart).reduce((sum, item) => sum + item.qty, 0);
            const totalPrice = Object.values(cart).reduce((sum, item) => sum + (item.price * item.qty), 0);

            if (totalQty > 0) {
                cartBtn.style.display = "flex";
                cartCount.textContent = totalQty;
                cartTotal.textContent = `Â¥${totalPrice.toLocaleString()}`;
            } else {
                cartBtn.style.display = "none";
            }
        }

        // 6. æ³¨æ–‡ç¢ºå®šå‡¦ç†
        cartBtn.onclick = () => {
            renderCartModal();
            cartModal.style.display = 'flex';
        };
        document.getElementById('close-cart').onclick = () => cartModal.style.display = 'none';

        function renderCartModal() {
            cartList.innerHTML = "";
            let total = 0;
            Object.values(cart).forEach(item => {
                const subtotal = item.price * item.qty;
                total += subtotal;
                cartList.innerHTML += `
                    <div class="cart-item">
                        <div>${item.name} x ${item.qty}</div>
                        <div>Â¥${subtotal.toLocaleString()}</div>
                    </div>
                `;
            });
            document.getElementById('modal-total').textContent = `Â¥${total.toLocaleString()}`;
        }

        document.getElementById('confirm-order-btn').addEventListener('click', async () => {
            const btn = document.getElementById('confirm-order-btn');
            btn.disabled = true;
            btn.textContent = "é€ä¿¡ä¸­...";

            try {
                const batch = writeBatch(db);
                const slipRef = doc(db, "tenants", tenantId, "slips", slipId);
                
                let orderTotal = 0;
                let callAmountAdd = 0; // ã‚³ãƒ¼ãƒ«å¯¾è±¡ã®é‡‘é¡

                // å„ã‚¢ã‚¤ãƒ†ãƒ ã‚’ orders ã‚µãƒ–ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã«è¿½åŠ 
                const timestamp = new Date(); // JS Date object for manual use if needed, but serverTimestamp is better
                
                // ãƒãƒƒãƒæ›¸ãè¾¼ã¿ã ã¨addDocãŒä½¿ãˆãªã„ã®ã§ã€collectionå‚ç…§ã‹ã‚‰docRefã‚’ä½œã‚‹
                for (const item of Object.values(cart)) {
                    const newOrderRef = doc(collection(db, "tenants", tenantId, "slips", slipId, "orders"));
                    batch.set(newOrderRef, {
                        name: item.name,
                        price: item.price,
                        quantity: item.qty,
                        productId: item.id,
                        orderedBy: myUid,
                        status: 'served', // æœ¬æ¥ã¯ ordered -> served ã ãŒç°¡æ˜“åŒ–
                        createdAt: serverTimestamp(),
                        isCallTarget: item.isCallTarget || false
                    });

                    const lineTotal = item.price * item.qty;
                    orderTotal += lineTotal;
                    
                    if (item.isCallTarget) {
                        callAmountAdd += lineTotal;
                    }
                }

                // ä¼ç¥¨ã®åˆè¨ˆé‡‘é¡ãªã©ã‚’æ›´æ–°
                batch.update(slipRef, {
                    totalAmount: increment(orderTotal),
                    callBatchAmount: increment(callAmountAdd), // æœªæ¶ˆåŒ–ã‚³ãƒ¼ãƒ«é‡‘é¡ã«åŠ ç®—
                    lastUpdated: serverTimestamp()
                });

                await batch.commit();

                alert("æ³¨æ–‡ãŒå®Œäº†ã—ã¾ã—ãŸï¼");
                window.location.href = `order.html`; // ãƒ†ãƒ¼ãƒ–ãƒ«é¸æŠã¸æˆ»ã‚‹

            } catch (error) {
                console.error(error);
                alert("æ³¨æ–‡ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ");
                btn.disabled = false;
            }
        });

        // --- é–‹ç™ºç”¨: ãƒ‡ãƒ¢å•†å“ä½œæˆãƒ„ãƒ¼ãƒ« ---
        document.getElementById('create-demo-products').onclick = async (e) => {
            e.preventDefault();
            if(!confirm("ãƒ†ã‚¹ãƒˆç”¨ã®å•†å“ãƒ‡ãƒ¼ã‚¿ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿ")) return;

            const demoProducts = [
                { name: "ã‚¢ã‚µãƒ’ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒ‰ãƒ©ã‚¤", price: 1000, category: "Beer", isCallTarget: false },
                { name: "é¡æœˆ Green", price: 5000, category: "Shochu", isCallTarget: false },
                { name: "ã‚«ãƒ•ã‚§ãƒ»ãƒ‰ãƒ»ãƒ‘ãƒª", price: 30000, category: "Champagne", isCallTarget: true },
                { name: "ãƒ¢ã‚¨ãƒ»ã‚¨ãƒ»ã‚·ãƒ£ãƒ³ãƒ‰ãƒ³ ç™½", price: 80000, category: "Champagne", isCallTarget: true },
                { name: "ãƒ‰ãƒ³ãƒ»ãƒšãƒªãƒ‹ãƒ¨ãƒ³", price: 150000, category: "Champagne", isCallTarget: true },
                { name: "ã‚¨ãƒ³ã‚¸ã‚§ãƒ«ãƒ»ã‚·ãƒ£ãƒ³ãƒ‘ãƒ³", price: 500000, category: "Champagne", isCallTarget: true },
                { name: "ãƒ•ãƒ«ãƒ¼ãƒ„ç››ã‚Šåˆã‚ã›", price: 10000, category: "Food", isCallTarget: false },
                { name: "ãƒŸãƒãƒ©ãƒ«ã‚¦ã‚©ãƒ¼ã‚¿ãƒ¼", price: 500, category: "SoftDrink", isCallTarget: false },
            ];

            const colRef = collection(db, "tenants", tenantId, "products");
            for(const p of demoProducts) {
                await addDoc(colRef, { ...p, createdAt: serverTimestamp() });
            }
            alert("å•†å“ã‚’ç™»éŒ²ã—ã¾ã—ãŸï¼ç”»é¢ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã€‚");
            location.reload();
        };

        // åˆæœŸå®Ÿè¡Œ
        loadSlip();
        loadProducts();

    </script>
</body>
</html>