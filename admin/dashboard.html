<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOSPOS - Dashboard</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 既存スタイル */
        .dashboard-container { display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background-color: #fff; border-right: 1px solid var(--border-color); padding: 20px; display: flex; flex-direction: column; }
        .main-content { flex: 1; padding: 30px; background-color: var(--bg-color); }
        .menu-item { padding: 12px; color: var(--text-main); text-decoration: none; display: flex; align-items: center; gap: 10px; border-radius: 8px; margin-bottom: 5px; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background-color: #e6f2ff; color: var(--primary-color); }
        .brand { font-size: 1.5rem; font-weight: bold; color: var(--primary-color); margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }
        .logout-btn { margin-top: auto; color: var(--error-color); }
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: white; padding: 20px; border-radius: 12px; box-shadow: var(--shadow-sm); position: relative; overflow: hidden; }
        .stat-title { color: var(--text-sub); font-size: 0.9rem; font-weight: bold; }
        .stat-value { font-size: 2rem; font-weight: bold; margin-top: 5px; color: var(--text-main); }
        .stat-sub { font-size: 0.8rem; color: #28a745; margin-top: 5px; }
        .today-info { background: #e6f2ff; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; align-items: center; gap: 15px; border-left: 5px solid var(--primary-color); display: none; }
        .info-icon { font-size: 1.5rem; color: var(--primary-color); }
        .tables-section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .tables-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 20px; }
        .dash-table-card { background: white; border-radius: 12px; padding: 15px; box-shadow: var(--shadow-sm); border-top: 4px solid #ccc; transition: transform 0.2s; cursor: pointer; position: relative; }
        .dash-table-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-lg); }
        .status-active { border-top-color: #dc3545; background: #fff5f5; }
        .dt-header { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 10px; font-size: 1.1rem; padding-right: 20px; }
        .dt-customer { font-size: 0.9rem; margin-bottom: 5px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .dt-amount { font-size: 1.2rem; font-weight: bold; color: var(--text-main); margin-bottom: 5px; }
        .dt-timer { background: rgba(0,0,0,0.05); padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; color: #666; display: inline-block; }
        .card-menu-btn { position: absolute; top: 10px; right: 10px; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #999; cursor: pointer; transition: 0.2s; z-index: 5; }
        .card-menu-btn:hover { background-color: rgba(0,0,0,0.1); color: #333; }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 400px; box-shadow: var(--shadow-lg); max-width: 90%; max-height: 80vh; overflow-y: auto; }
        .modal-title { font-size: 1.2rem; font-weight: bold; margin-bottom: 20px; }
        .input-box { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; margin-bottom: 20px; font-size: 1rem; background-color: #fff; }
        #context-menu { display: none; position: absolute; z-index: 2000; background: white; border: 1px solid #ddd; border-radius: 6px; box-shadow: 2px 2px 10px rgba(0,0,0,0.2); width: 150px; }
        .ctx-item { padding: 12px 15px; cursor: pointer; font-size: 0.9rem; border-bottom: 1px solid #f0f0f0; }
        .ctx-item:hover { background: #f8f9fa; color: var(--primary-color); }
        .btn-create { background: var(--primary-color); color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .admin-mobile-header { display: none; background: white; padding: 15px; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow-sm); }
        .mobile-menu-btn { background: none; border: none; font-size: 1.5rem; }
        @media (max-width: 768px) {
            .dashboard-container { flex-direction: column; }
            .sidebar { display: none; width: 100%; position: fixed; top: 60px; left: 0; height: calc(100vh - 60px); z-index: 99; }
            .sidebar.active { display: flex; }
            .admin-mobile-header { display: flex; }
            .main-content { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="admin-mobile-header">
        <div style="font-weight:bold; font-size:1.2rem; color:var(--primary-color);"><i class="fas fa-glass-cheers"></i> HOSPOS</div>
        <button class="mobile-menu-btn" id="mobile-menu-toggle"><i class="fas fa-bars"></i></button>
    </div>

    <div class="dashboard-container">
        <div class="sidebar" id="sidebar">
            <div class="brand"><i class="fas fa-glass-cheers"></i> HOSPOS</div>
            <nav>
                <a href="dashboard.html" class="menu-item active"><i class="fas fa-tachometer-alt"></i> ダッシュボード</a>
                <a href="schedule.html" class="menu-item"><i class="fas fa-calendar-alt"></i> スケジュール</a>
                <a href="slips.html" class="menu-item"><i class="fas fa-file-invoice-dollar"></i> 伝票一覧</a>
                <a href="call-management.html" class="menu-item"><i class="fas fa-music"></i> コール管理</a>
                <a href="shokai-control.html" class="menu-item"><i class="fas fa-users"></i> 初回・付け回し</a>
                <a href="products.html" class="menu-item"><i class="fas fa-wine-bottle"></i> 商品管理</a>
                <a href="inventory.html" class="menu-item"><i class="fas fa-boxes"></i> 在庫管理</a>
                <a href="cast-list.html" class="menu-item"><i class="fas fa-user-tie"></i> キャスト管理</a>
                <a href="attendance.html" class="menu-item"><i class="fas fa-clock"></i> 出勤管理</a>
                <a href="salary.html" class="menu-item"><i class="fas fa-money-bill-wave"></i> 給与管理</a>
                <a href="customers.html" class="menu-item"><i class="fas fa-address-book"></i> 顧客管理</a>
                <a href="sales-analysis.html" class="menu-item"><i class="fas fa-chart-line"></i> 売上分析</a>
                <a href="ranking.html" class="menu-item"><i class="fas fa-trophy"></i> ランキング</a>
                <a href="daily-report.html" class="menu-item"><i class="fas fa-file-alt"></i> 日報・ログ</a>
                <a href="settings.html" class="menu-item"><i class="fas fa-cog"></i> 店舗設定</a>
            </nav>
            <a href="#" id="logout-btn" class="menu-item logout-btn"><i class="fas fa-sign-out-alt"></i> ログアウト</a>
        </div>

        <div class="main-content">
            <div id="today-schedule" class="today-info"><i class="fas fa-info-circle info-icon"></i><div class="info-content" id="schedule-text"></div></div>
            <div class="stats-grid">
                <div class="stat-card card-sales"><div class="stat-title">本日の総売上</div><div class="stat-value" id="daily-sales">¥0</div><div class="stat-sub" id="active-sales-sub">(未会計: ¥0)</div></div>
                <div class="stat-card card-guests"><div class="stat-title">現在の組数</div><div class="stat-value"><span id="active-count">0</span> <span style="font-size:1rem;">組</span></div></div>
                <div class="stat-card"><div class="stat-title">出勤キャスト</div><div class="stat-value"><span id="cast-count">0</span> <span style="font-size:1rem;">名</span></div></div>
            </div>
            <div class="tables-section-header">
                <h3><i class="fas fa-couch"></i> リアルタイム稼働状況</h3>
                <button class="btn-create" onclick="openNewSlipModal()"><i class="fas fa-plus"></i> 新規伝票作成</button>
            </div>
            <div id="active-tables-grid" class="tables-grid"><div style="grid-column:1/-1; text-align:center; padding:30px; color:#aaa;">読み込み中...</div></div>
        </div>
    </div>

    <div id="move-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">テーブル移動</div>
            <p style="margin-bottom:10px;">現在: <span id="move-from-name" style="font-weight:bold;"></span></p>
            <label>移動先</label><select id="move-to-name" class="input-box"></select>
            <div style="display:flex; gap:10px; justify-content:flex-end;"><button id="cancel-move" class="btn-primary" style="background:#ccc; width:auto;">キャンセル</button><button id="confirm-move" class="btn-primary" style="width:auto;">移動する</button></div>
        </div>
    </div>

    <div id="new-slip-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-title">新規伝票作成</div>
            <form id="new-slip-form">
                <label style="font-weight:bold;">テーブル選択</label>
                <select id="new-slip-table" class="input-box" required></select>
                
                <label style="font-weight:bold;">来店種別</label>
                <select id="new-slip-type" class="input-box" onchange="toggleCastSelect(this.value)">
                    <option value="free">フリー</option>
                    <option value="shime">指名</option>
                    <option value="eda">枝</option>
                </select>

                <div id="cast-select-container" style="display:none;">
                    <label style="font-weight:bold;">指名キャスト</label>
                    <select id="new-slip-cast" class="input-box" onchange="updateCustomerList(this.value)">
                        <option value="">選択してください</option>
                    </select>
                    <label style="font-weight:bold;">指名客 (担当顧客リスト)</label>
                    <select id="new-slip-customer-select" class="input-box" onchange="checkNewCustomer(this.value)">
                        <option value="">キャストを選択してください</option>
                    </select>
                </div>

                <label style="font-weight:bold;">人数</label>
                <input type="number" id="new-slip-count" class="input-box" value="1" min="1" required>

                <div id="new-customer-input-area" style="display:block;">
                    <label style="font-weight:bold;">お客様名 (新規/フリー)</label>
                    <input type="text" id="new-slip-customer" class="input-box" placeholder="名前を入力">
                </div>

                <div style="display:flex; gap:10px; justify-content:flex-end;">
                    <button type="button" class="btn-primary" style="background:#ccc; width:auto;" onclick="closeNewSlipModal()">キャンセル</button>
                    <button type="submit" class="btn-primary" style="width:auto;">作成して開始</button>
                </div>
            </form>
        </div>
    </div>

    <div id="context-menu">
        <div class="ctx-item" id="ctx-move"><i class="fas fa-exchange-alt"></i> 卓移動する</div>
        <div class="ctx-item" id="ctx-detail"><i class="fas fa-file-invoice"></i> 伝票詳細へ</div>
    </div>

    <script type="module">
        import { db, auth } from '../assets/js/firebase-config.js';
        import { signOut } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-auth.js";
        import { collection, query, where, onSnapshot, doc, updateDoc, getDoc, getDocs, runTransaction, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
        import { getBusinessDate, formatDateYMD } from '../assets/js/utils.js';

        const tenantId = sessionStorage.getItem('hospos_tenantId');
        if (!tenantId) window.location.href = "../index.html";

        const salesDisplay = document.getElementById('daily-sales');
        const activeSalesSub = document.getElementById('active-sales-sub');
        const activeCountDisplay = document.getElementById('active-count');
        const castCountDisplay = document.getElementById('cast-count');
        const tablesGrid = document.getElementById('active-tables-grid');
        
        let masterTables = ["T1", "T2", "T3", "T4", "T5", "T6", "T7", "T8", "VIP1", "VIP2"];
        let activeTableIds = new Set();
        let cutoffHour = 0;
        let castList = []; // [{id, name}]
        let castCustomers = {};

        document.getElementById('mobile-menu-toggle').onclick = () => document.getElementById('sidebar').classList.toggle('active');

        async function loadConfig() {
            try {
                const docSnap = await getDoc(doc(db, "tenants", tenantId));
                if(docSnap.exists()) {
                    const d = docSnap.data();
                    if(d.config?.tables?.length > 0) masterTables = d.config.tables;
                    if(d.config?.businessDay?.cutoffHour !== undefined) cutoffHour = d.config.businessDay.cutoffHour;
                }
                loadCasts();
                loadTodaySchedule();
                startDashboardListener();
            } catch(e) { console.error(e); }
        }

        async function loadCasts() {
            const q = query(collection(db, "tenants", tenantId, "users"), where("role", "==", "cast"));
            const snap = await getDocs(q);
            castList = [];
            const castSelect = document.getElementById('new-slip-cast');
            castSelect.innerHTML = '<option value="">選択してください</option>';
            snap.forEach(doc => {
                const d = doc.data();
                castList.push({ id: doc.id, name: d.name });
                const opt = document.createElement('option');
                opt.value = doc.id;
                opt.textContent = d.name;
                castSelect.appendChild(opt);
            });
        }

        window.updateCustomerList = async (castId) => {
            const custSelect = document.getElementById('new-slip-customer-select');
            if(!castId) { custSelect.innerHTML = '<option value="">キャストを選択してください</option>'; return; }
            
            custSelect.innerHTML = '<option>読み込み中...</option>';
            const q = query(collection(db, "tenants", tenantId, "customers"), where("assignedCastId", "==", castId));
            const snap = await getDocs(q);
            
            castCustomers[castId] = [];
            let html = '<option value="NEW">★新規登録 (入力)</option>';
            snap.forEach(doc => {
                const c = doc.data();
                castCustomers[castId].push(c.name);
                html += `<option value="${c.name}">${c.name}</option>`;
            });
            custSelect.innerHTML = html;
            checkNewCustomer("NEW");
        };

        window.checkNewCustomer = (val) => {
            const inputArea = document.getElementById('new-customer-input-area');
            const nameInput = document.getElementById('new-slip-customer');
            if(val === 'NEW') { inputArea.style.display = 'block'; nameInput.value = ""; nameInput.required = true; } 
            else { inputArea.style.display = 'none'; nameInput.value = val; nameInput.required = false; }
        };

        function loadTodaySchedule() { /* 省略 */ }

        function startDashboardListener() {
            const todayStart = getBusinessDate(new Date(), cutoffHour);
            todayStart.setHours(cutoffHour, 0, 0, 0);
            const q = query(collection(db, "tenants", tenantId, "slips")); 
            onSnapshot(q, (snapshot) => {
                let totalSales = 0, activeSales = 0, activeCount = 0;
                const activeSlips = [];
                activeTableIds.clear();
                snapshot.forEach(doc => {
                    const data = doc.data();
                    const slipDate = data.startTime ? data.startTime.toDate() : new Date();
                    const isTodayBusiness = slipDate >= todayStart;
                    if (data.status === 'paid' && isTodayBusiness) totalSales += (data.totalAmount || 0);
                    else if (data.status === 'active' && isTodayBusiness) {
                        activeSales += (data.totalAmount || 0);
                        totalSales += (data.totalAmount || 0);
                        activeCount++;
                        activeSlips.push({ id: doc.id, ...data });
                        activeTableIds.add(data.tableId);
                    }
                });
                salesDisplay.textContent = `¥${totalSales.toLocaleString()}`;
                activeSalesSub.textContent = `(うち未会計: ¥${activeSales.toLocaleString()})`;
                activeCountDisplay.textContent = activeCount;
                renderActiveTables(activeSlips);
            });
            const castQ = query(collection(db, "tenants", tenantId, "users"), where("role", "==", "cast"), where("currentStatus", "==", "working"));
            onSnapshot(castQ, (snap) => { castCountDisplay.textContent = snap.size; });
        }
        
        function renderActiveTables(slips) {
            tablesGrid.innerHTML = "";
            if(slips.length === 0) { tablesGrid.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:30px; color:#aaa;">稼働なし</div>`; return; }
            slips.sort((a,b) => a.tableId.localeCompare(b.tableId));
            slips.forEach(slip => {
                // 指名の場合、キャスト名を表示
                let typeLabel = 'Free';
                if (slip.visitType === 'shime') {
                    const cName = slip.primaryCastName ? `指名: ${slip.primaryCastName}` : '指名';
                    typeLabel = `<span style="color:#007bff; font-weight:bold;">${cName}</span>`;
                } else if (slip.visitType === 'eda') {
                    typeLabel = '枝';
                }

                const div = document.createElement('div');
                div.className = "dash-table-card status-active";
                div.innerHTML = `
                    <div class="card-menu-btn" onclick="openMenu(event, '${slip.id}', '${slip.tableId}')"><i class="fas fa-ellipsis-v"></i></div>
                    <div class="dt-header"><span>${slip.tableId}</span><span style="font-size:0.8rem;">${typeLabel}</span></div>
                    <div class="dt-customer">${slip.customerName} 様</div>
                    <div class="dt-amount">¥${(slip.totalAmount||0).toLocaleString()}</div>
                    <div class="dt-timer"><i class="fas fa-clock"></i> <span class="timer-text">00:00</span></div>
                `;
                div.onclick = (e) => { if(!e.target.closest('.card-menu-btn')) window.location.href = `slip-detail.html?id=${slip.id}`; };
                tablesGrid.appendChild(div);
            });
            updateTimers();
        }

        function updateTimers() {
            const cards = document.querySelectorAll('.dash-table-card');
            const now = Date.now();
            cards.forEach(card => {
                // (省略: 前回と同じ実装)
            });
        }
        setInterval(updateTimers, 60000);

        // 新規伝票作成
        const newSlipModal = document.getElementById('new-slip-modal');
        window.openNewSlipModal = () => {
            const select = document.getElementById('new-slip-table');
            select.innerHTML = "";
            masterTables.forEach(tbl => {
                const isBusy = activeTableIds.has(tbl);
                const opt = document.createElement('option');
                opt.value = tbl; opt.textContent = tbl + (isBusy ? " (使用中/相席)" : "");
                if(isBusy) opt.style.color = "red";
                select.appendChild(opt);
            });
            document.getElementById('new-slip-customer').value = "";
            document.getElementById('new-slip-count').value = 1;
            document.getElementById('new-slip-type').value = 'free';
            toggleCastSelect('free');
            newSlipModal.style.display = 'flex';
        };
        window.closeNewSlipModal = () => newSlipModal.style.display = 'none';

        window.toggleCastSelect = (type) => {
            const container = document.getElementById('cast-select-container');
            const inputArea = document.getElementById('new-customer-input-area');
            if(type === 'shime') { container.style.display = 'block'; inputArea.style.display = 'none'; }
            else { container.style.display = 'none'; inputArea.style.display = 'block'; }
        };

        document.getElementById('new-slip-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const btn = e.target.querySelector('button[type="submit"]');
            btn.disabled = true; btn.textContent = "作成中...";

            const tableId = document.getElementById('new-slip-table').value;
            const type = document.getElementById('new-slip-type').value;
            const count = Number(document.getElementById('new-slip-count').value);
            let custName = document.getElementById('new-slip-customer').value;
            const castId = document.getElementById('new-slip-cast').value;
            const custSelectVal = document.getElementById('new-slip-customer-select').value;

            // キャスト名解決 (指名の場合)
            let castName = null;
            if (type === 'shime') {
                if (!castId) { alert("キャストを選択してください"); btn.disabled = false; return; }
                const cObj = castList.find(c => c.id === castId);
                castName = cObj ? cObj.name : "不明";

                if (custSelectVal === 'NEW') {
                    if(castCustomers[castId] && castCustomers[castId].includes(custName)) {
                        alert("その名前の顧客は既に存在します。リストから選択してください。");
                        btn.disabled = false; return;
                    }
                    // 新規顧客登録
                    try {
                        await addDoc(collection(db, "tenants", tenantId, "customers"), {
                            name: custName, assignedCastId: castId, createdAt: serverTimestamp(), lastUpdated: serverTimestamp()
                        });
                    } catch(e) { console.error(e); }
                } else {
                    custName = custSelectVal;
                }
            }

            try {
                const businessDate = getBusinessDate(new Date(), cutoffHour);
                const dateStr = formatDateYMD(businessDate);
                
                await runTransaction(db, async (transaction) => {
                    const counterRef = doc(db, "tenants", tenantId, "counters", dateStr);
                    const counterDoc = await transaction.get(counterRef);
                    let newNumber = 1;
                    if (counterDoc.exists()) newNumber = counterDoc.data().count + 1;
                    transaction.set(counterRef, { count: newNumber }, { merge: true });

                    const slipRef = doc(collection(db, "tenants", tenantId, "slips"));
                    transaction.set(slipRef, {
                        tableId: tableId, status: "active", startTime: serverTimestamp(),
                        primaryCastId: (type === 'shime') ? castId : null,
                        primaryCastName: castName, // ★キャスト名も保存
                        customerName: custName || "新規客様",
                        visitType: type, guestCount: count,
                        totalAmount: 0, callBatchAmount: 0, slipNumber: newNumber, businessDate: dateStr, orders: []
                    });
                });
                closeNewSlipModal();
            } catch(error) { alert("作成エラー: " + error.message); } 
            finally { btn.disabled = false; btn.textContent = "作成して開始"; }
        });

        // Context Menu Logic (省略: 前回と同じ)
        let selectedSlipId = null; let selectedTableId = null;
        window.openMenu = (e, slipId, tableId) => { e.stopPropagation(); selectedSlipId = slipId; selectedTableId = tableId; const menu = document.getElementById('context-menu'); menu.style.top = `${e.pageY}px`; menu.style.left = `${e.pageX-100}px`; menu.style.display = 'block'; };
        window.addEventListener('click', () => document.getElementById('context-menu').style.display = 'none');
        document.getElementById('ctx-move').onclick = () => { document.getElementById('move-from-name').textContent = selectedTableId; document.getElementById('move-to-name').innerHTML = ""; masterTables.forEach(t => { if(t!==selectedTableId) document.getElementById('move-to-name').innerHTML += `<option value="${t}">${t}</option>`; }); document.getElementById('move-modal').style.display = 'flex'; };
        document.getElementById('confirm-move').onclick = async () => { const to = document.getElementById('move-to-name').value; await updateDoc(doc(db, "tenants", tenantId, "slips", selectedSlipId), { tableId: to }); document.getElementById('move-modal').style.display = 'none'; };
        document.getElementById('cancel-move').onclick = () => document.getElementById('move-modal').style.display = 'none';
        document.getElementById('ctx-detail').onclick = () => window.location.href = `slip-detail.html?id=${selectedSlipId}`;
        document.getElementById('logout-btn').addEventListener('click', async (e) => { e.preventDefault(); await signOut(auth); sessionStorage.clear(); window.location.href = "../index.html"; });

        loadConfig();
    </script>
</body>
</html>