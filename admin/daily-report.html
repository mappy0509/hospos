<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOSPOS - æ—¥å ±ä½œæˆ</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* å…±é€šãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ */
        .dashboard-container { display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background-color: #fff; border-right: 1px solid var(--border-color); padding: 20px; display: flex; flex-direction: column; }
        .main-content { flex: 1; padding: 30px; background-color: var(--bg-color); }
        
        .menu-item { padding: 12px; color: var(--text-main); text-decoration: none; display: flex; align-items: center; gap: 10px; border-radius: 8px; margin-bottom: 5px; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background-color: #e6f2ff; color: var(--primary-color); }
        .brand { font-size: 1.5rem; font-weight: bold; color: var(--primary-color); margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }

        /* æ—¥å ±ä½œæˆã‚¨ãƒªã‚¢ */
        .report-container {
            background: white; padding: 30px; border-radius: 12px; box-shadow: var(--shadow-sm);
            max-width: 800px; margin: 0 auto;
        }

        .control-bar {
            display: flex; gap: 15px; align-items: flex-end; margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px;
        }
        .date-group label { display: block; font-weight: bold; margin-bottom: 5px; }
        .date-input { padding: 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; }
        
        .btn-generate {
            padding: 10px 25px; background: var(--primary-color); color: white; border: none; 
            border-radius: 6px; cursor: pointer; font-weight: bold; height: 42px;
        }
        .btn-generate:hover { background: #0056b3; }

        /* ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ */
        .report-preview {
            width: 100%; height: 400px; padding: 15px;
            border: 1px solid #ddd; border-radius: 8px;
            font-family: "Hiragino Kaku Gothic ProN", "Meiryo", monospace;
            font-size: 0.9rem; line-height: 1.6;
            background-color: #f8f9fa; resize: vertical;
        }

        .action-area {
            display: flex; justify-content: flex-end; gap: 15px; margin-top: 20px;
        }
        .btn-copy {
            padding: 12px 30px; background: #28a745; color: white; border: none;
            border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 1rem;
            display: flex; align-items: center; gap: 8px;
        }
        .btn-copy:hover { background: #218838; }

        /* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º */
        .status-msg { margin-top: 10px; color: #28a745; font-weight: bold; display: none; text-align: right;}
    </style>
</head>
<body>

    <div class="dashboard-container">
        <div class="sidebar">
            <div class="brand"><i class="fas fa-glass-cheers"></i> HOSPOS</div>
            <nav>
                <a href="dashboard.html" class="menu-item"><i class="fas fa-tachometer-alt"></i> ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰</a>
                <a href="slips.html" class="menu-item"><i class="fas fa-file-invoice-dollar"></i> ä¼ç¥¨ä¸€è¦§</a>
                <a href="call-management.html" class="menu-item"><i class="fas fa-music"></i> ã‚³ãƒ¼ãƒ«ç®¡ç†</a>
                <a href="shokai-control.html" class="menu-item"><i class="fas fa-users"></i> åˆå›ãƒ»ä»˜ã‘å›ã—</a>
                <a href="products.html" class="menu-item"><i class="fas fa-wine-bottle"></i> å•†å“ç®¡ç†</a>
                <a href="inventory.html" class="menu-item"><i class="fas fa-boxes"></i> åœ¨åº«ç®¡ç†</a>
                <a href="cast-list.html" class="menu-item"><i class="fas fa-user-tie"></i> ã‚­ãƒ£ã‚¹ãƒˆç®¡ç†</a>
                <a href="attendance.html" class="menu-item"><i class="fas fa-clock"></i> å‡ºå‹¤ç®¡ç†</a>
                <a href="customers.html" class="menu-item"><i class="fas fa-address-book"></i> é¡§å®¢ç®¡ç†</a>
                <a href="sales-analysis.html" class="menu-item"><i class="fas fa-chart-line"></i> å£²ä¸Šåˆ†æ</a>
                <a href="ranking.html" class="menu-item"><i class="fas fa-trophy"></i> ãƒ©ãƒ³ã‚­ãƒ³ã‚°</a>
                <a href="daily-report.html" class="menu-item active"><i class="fas fa-file-alt"></i> æ—¥å ±ãƒ»ãƒ­ã‚°</a>
                <a href="settings.html" class="menu-item"><i class="fas fa-cog"></i> åº—èˆ—è¨­å®š</a>
            </nav>
        </div>

        <div class="main-content">
            <h2 style="margin-bottom: 20px;"><i class="fas fa-file-alt"></i> æ¥­å‹™æ—¥å ±ä½œæˆ</h2>
            
            <div class="report-container">
                <div class="control-bar">
                    <div class="date-group">
                        <label>å¯¾è±¡æ—¥ã‚’é¸æŠ</label>
                        <input type="date" id="report-date" class="date-input">
                    </div>
                    <button id="generate-btn" class="btn-generate"><i class="fas fa-sync-alt"></i> é›†è¨ˆã—ã¦ä½œæˆ</button>
                </div>

                <p style="font-size:0.9rem; color:#666; margin-bottom:10px;">
                    ä»¥ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã¯è‡ªç”±ã«ç·¨é›†ã§ãã¾ã™ã€‚å†…å®¹ã‚’ç¢ºèªå¾Œã€ã‚³ãƒ”ãƒ¼ã—ã¦LINEç­‰ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚
                </p>
                
                <textarea id="report-text" class="report-preview" spellcheck="false">ï¼ˆæ—¥ä»˜ã‚’é¸æŠã—ã¦ã€Œé›†è¨ˆã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„ï¼‰</textarea>

                <div class="status-msg" id="copy-msg">ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼</div>

                <div class="action-area">
                    <button id="copy-btn" class="btn-copy">
                        <i class="fas fa-copy"></i> ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from '../assets/js/firebase-config.js';
        import { collection, query, where, getDocs, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        const tenantId = sessionStorage.getItem('hospos_tenantId');
        if (!tenantId) window.location.href = "../index.html";

        const dateInput = document.getElementById('report-date');
        const generateBtn = document.getElementById('generate-btn');
        const reportText = document.getElementById('report-text');
        const copyBtn = document.getElementById('copy-btn');
        const copyMsg = document.getElementById('copy-msg');

        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ä»Šæ—¥ã®æ—¥ä»˜ã‚’ã‚»ãƒƒãƒˆ
        dateInput.valueAsDate = new Date();

        // 1. é›†è¨ˆã¨ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ
        generateBtn.addEventListener('click', async () => {
            generateBtn.disabled = true;
            generateBtn.textContent = "é›†è¨ˆä¸­...";
            reportText.value = "ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...";

            try {
                // æ—¥ä»˜ç¯„å›²ã®è¨ˆç®—
                const targetDate = new Date(dateInput.value);
                const startOfDay = new Date(targetDate);
                startOfDay.setHours(0, 0, 0, 0);
                const endOfDay = new Date(targetDate);
                endOfDay.setHours(23, 59, 59, 999);

                // åº—èˆ—æƒ…å ±ã®å–å¾—ï¼ˆåº—åãªã©ï¼‰
                const shopSnap = await getDoc(doc(db, "tenants", tenantId));
                const shopName = shopSnap.exists() ? shopSnap.data().name : "å½“åº—";

                // ã‚­ãƒ£ã‚¹ãƒˆæƒ…å ±ã®å–å¾— (ID -> åå‰å¤‰æ›ç”¨)
                const castMap = {};
                const castSnap = await getDocs(query(collection(db, "tenants", tenantId, "users"), where("role", "==", "cast")));
                castSnap.forEach(d => { castMap[d.id] = d.data().name; });

                // ä¼ç¥¨ãƒ‡ãƒ¼ã‚¿ã®å–å¾—
                // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ä¸è¦ã«ã™ã‚‹ãŸã‚ã€where("startTime")ã‚’ä½¿ã‚ãšå…¨ä»¶å–å¾—ã—ã¦JSãƒ•ã‚£ãƒ«ã‚¿ï¼ˆä»¶æ•°å¢—ãˆãŸã‚‰è¦ä¿®æ­£ï¼‰
                // â€»ç›´è¿‘ã®é‹ç”¨ãªã‚‰å•é¡Œãªã—
                const slipsSnap = await getDocs(collection(db, "tenants", tenantId, "slips"));
                
                let totalSales = 0;
                let totalGroups = 0;
                
                let cashTotal = 0;
                let cardTotal = 0;
                let debtTotal = 0; // å£²æ›
                let activeTotal = 0; // æœªä¼šè¨ˆï¼ˆå–¶æ¥­ä¸­ï¼‰

                let castSales = {}; // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ç”¨

                slipsSnap.forEach(doc => {
                    const data = doc.data();
                    const sDate = data.startTime ? data.startTime.toDate() : null;

                    // æ²¡é›»ä»¥å¤–ã€ã‹ã¤å¯¾è±¡æ—¥ã®ãƒ‡ãƒ¼ã‚¿
                    if (data.status !== 'void' && sDate && sDate >= startOfDay && sDate <= endOfDay) {
                        const amount = data.totalAmount || 0;
                        totalSales += amount;
                        totalGroups += 1;

                        // å†…è¨³è¨ˆç®—
                        if (data.status === 'paid') {
                            const details = data.paymentDetails || {};
                            cashTotal += (details.cash || 0);
                            cardTotal += (details.card || 0);
                            debtTotal += (details.credit || 0);
                        } else {
                            activeTotal += amount;
                        }

                        // ã‚­ãƒ£ã‚¹ãƒˆåˆ¥é›†è¨ˆ
                        const castId = data.primaryCastId;
                        if (castId && castMap[castId]) {
                            castSales[castId] = (castSales[castId] || 0) + amount;
                        }
                    }
                });

                // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä½œæˆ (Top 3)
                const sortedCasts = Object.keys(castSales)
                    .map(id => ({ name: castMap[id], sales: castSales[id] }))
                    .sort((a, b) => b.sales - a.sales)
                    .slice(0, 3);

                // å®¢å˜ä¾¡
                const avgSpend = totalGroups > 0 ? Math.floor(totalSales / totalGroups) : 0;

                // --- ãƒ†ã‚­ã‚¹ãƒˆç”Ÿæˆ (Template Literal) ---
                const dateStr = targetDate.toLocaleDateString('ja-JP', { month: 'numeric', day: 'numeric', weekday: 'short' });
                
                let text = `ã€${shopName} æ—¥å ±ã€‘\n`;
                text += `${dateStr}\n\n`;
                
                text += `â–  å£²ä¸Šåˆè¨ˆ: Â¥${totalSales.toLocaleString()}\n`;
                text += `------------------\n`;
                text += `ãƒ»ç¾é‡‘: Â¥${cashTotal.toLocaleString()}\n`;
                text += `ãƒ»ã‚«ãƒ¼ãƒ‰: Â¥${cardTotal.toLocaleString()}\n`;
                text += `ãƒ»å£²æ›: Â¥${debtTotal.toLocaleString()}\n`;
                if(activeTotal > 0) text += `ãƒ»æœªä¼šè¨ˆ(å–¶æ¥­ä¸­): Â¥${activeTotal.toLocaleString()}\n`;
                text += `------------------\n`;
                text += `â–  çµ„æ•°: ${totalGroups}çµ„\n`;
                text += `â–  å®¢å˜ä¾¡: Â¥${avgSpend.toLocaleString()}\n\n`;

                text += `ã€æœ¬æ—¥ã®Rankingã€‘\n`;
                if(sortedCasts.length > 0) {
                    sortedCasts.forEach((c, i) => {
                        const medal = i===0 ? "ğŸ¥‡" : (i===1 ? "ğŸ¥ˆ" : "ğŸ¥‰");
                        text += `${medal} ${c.name} (Â¥${c.sales.toLocaleString()})\n`;
                    });
                } else {
                    text += `è©²å½“ãƒ‡ãƒ¼ã‚¿ãªã—\n`;
                }

                text += `\nã€é€£çµ¡äº‹é …ã€‘\n`;
                text += `ãƒ»\nãƒ»\n`; // ç©ºæ¬„ã«ã—ã¦ãŠã
                text += `\nãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚`;

                reportText.value = text;

            } catch (error) {
                console.error(error);
                reportText.value = "ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + error.message;
            } finally {
                generateBtn.disabled = false;
                generateBtn.textContent = '<i class="fas fa-sync-alt"></i> é›†è¨ˆã—ã¦ä½œæˆ';
                generateBtn.innerHTML = '<i class="fas fa-sync-alt"></i> é›†è¨ˆã—ã¦ä½œæˆ'; // ã‚¢ã‚¤ã‚³ãƒ³å¾©å¸°
            }
        });

        // 2. ã‚³ãƒ”ãƒ¼æ©Ÿèƒ½
        copyBtn.addEventListener('click', () => {
            reportText.select();
            navigator.clipboard.writeText(reportText.value).then(() => {
                copyMsg.style.display = 'block';
                setTimeout(() => copyMsg.style.display = 'none', 2000);
            });
        });

    </script>
</body>
</html>