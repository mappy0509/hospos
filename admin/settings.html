<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOSPOS - 店舗設定</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 共通スタイル */
        .dashboard-container { display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background-color: #fff; border-right: 1px solid var(--border-color); padding: 20px; display: flex; flex-direction: column; }
        .main-content { flex: 1; padding: 40px; background-color: var(--bg-color); }
        .menu-item { padding: 12px; color: var(--text-main); text-decoration: none; display: flex; align-items: center; gap: 10px; border-radius: 8px; margin-bottom: 5px; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background-color: #e6f2ff; color: var(--primary-color); }
        .brand { font-size: 1.5rem; font-weight: bold; color: var(--primary-color); margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }

        /* 設定フォーム共通 */
        .settings-container { max-width: 900px; margin: 0 auto; }
        .settings-section { background: white; padding: 30px; border-radius: 0 0 12px 12px; box-shadow: var(--shadow-sm); margin-bottom: 30px; display: none; animation: fadeIn 0.3s ease-out; }
        .settings-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .section-title { font-size: 1.1rem; font-weight: bold; margin-bottom: 20px; padding-bottom: 10px; border-bottom: 2px solid #f0f0f0; color: var(--primary-color); display: flex; align-items: center; gap: 10px; }
        
        /* タブナビゲーション */
        .tabs-nav { display: flex; gap: 5px; overflow-x: auto; border-bottom: 2px solid #ddd; padding-bottom: 0; margin-bottom: 0; }
        .tab-btn {
            padding: 12px 20px; background: #e9ecef; border: none; border-radius: 8px 8px 0 0;
            cursor: pointer; font-weight: bold; color: #666; transition: 0.2s; flex: 1; min-width: 120px; text-align: center;
        }
        .tab-btn:hover { background: #dee2e6; }
        .tab-btn.active { background: var(--primary-color); color: white; }
        .tab-content-wrapper { background: white; border-radius: 0 0 12px 12px; box-shadow: var(--shadow-sm); }

        /* 入力フォーム */
        .input-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: bold; font-size: 0.95rem; }
        .form-group input, .form-group select { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; }
        .helper-text { font-size: 0.85rem; color: var(--text-sub); margin-top: 5px; line-height: 1.4; }

        /* 保存エリア */
        .save-area { position: sticky; bottom: 20px; background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); padding: 15px 30px; border-radius: 12px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; border: 1px solid var(--border-color); max-width: 900px; margin: 0 auto; }

        /* リスト追加系 */
        .list-row { display: flex; gap: 10px; align-items: center; margin-bottom: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px; border: 1px solid #eee; }
        .btn-add { background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 6px; cursor: pointer; margin-bottom: 10px; width: 100%; }
        .btn-delete { background: #dc3545; color: white; border: none; padding: 8px; border-radius: 6px; cursor: pointer; }

        /* 曜日選択 */
        .week-selector { display: flex; gap: 5px; flex-wrap: wrap; }
        .week-chk { display: none; }
        .week-label { padding: 10px 0; width: 45px; text-align: center; border: 1px solid #ddd; border-radius: 6px; cursor: pointer; background: #fff; transition: 0.2s; font-weight: bold; color: #666; }
        .week-chk:checked + .week-label { background: var(--primary-color); color: white; border-color: var(--primary-color); }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <div class="sidebar">
            <div class="brand"><i class="fas fa-glass-cheers"></i> HOSPOS</div>
            <nav>
                <a href="dashboard.html" class="menu-item"><i class="fas fa-tachometer-alt"></i> ダッシュボード</a>
                <a href="schedule.html" class="menu-item"><i class="fas fa-calendar-alt"></i> スケジュール</a>
                <a href="slips.html" class="menu-item"><i class="fas fa-file-invoice-dollar"></i> 伝票一覧</a>
                <a href="call-management.html" class="menu-item"><i class="fas fa-music"></i> コール管理</a>
                <a href="shokai-control.html" class="menu-item"><i class="fas fa-users"></i> 初回・付け回し</a>
                <a href="products.html" class="menu-item"><i class="fas fa-wine-bottle"></i> 商品管理</a>
                <a href="inventory.html" class="menu-item"><i class="fas fa-boxes"></i> 在庫管理</a>
                <a href="cast-list.html" class="menu-item"><i class="fas fa-user-tie"></i> キャスト管理</a>
                <a href="attendance.html" class="menu-item"><i class="fas fa-clock"></i> 出勤管理</a>
                <a href="salary.html" class="menu-item"><i class="fas fa-money-bill-wave"></i> 給与管理</a>
                <a href="customers.html" class="menu-item"><i class="fas fa-address-book"></i> 顧客管理</a>
                <a href="sales-analysis.html" class="menu-item"><i class="fas fa-chart-line"></i> 売上分析</a>
                <a href="ranking.html" class="menu-item"><i class="fas fa-trophy"></i> ランキング</a>
                <a href="daily-report.html" class="menu-item"><i class="fas fa-file-alt"></i> 日報・ログ</a>
                <a href="settings.html" class="menu-item active"><i class="fas fa-cog"></i> 店舗設定</a>
            </nav>
        </div>

        <div class="main-content">
            <h2 style="margin-bottom: 20px;">店舗設定</h2>

            <form id="settings-form" class="settings-container">
                
                <div class="tabs-nav">
                    <button type="button" class="tab-btn active" onclick="switchTab('basic')"><i class="fas fa-store"></i> 基本・営業</button>
                    <button type="button" class="tab-btn" onclick="switchTab('accounting')"><i class="fas fa-calculator"></i> 会計・システム</button>
                    <button type="button" class="tab-btn" onclick="switchTab('salary')"><i class="fas fa-money-bill-wave"></i> 給与・報酬</button>
                    <button type="button" class="tab-btn" onclick="switchTab('call')"><i class="fas fa-music"></i> 演出・コール</button>
                </div>

                <div class="tab-content-wrapper">
                    
                    <div id="tab-basic" class="settings-section active">
                        <div class="section-title">基本情報</div>
                        <div class="form-group">
                            <label>店舗名（表示用）</label>
                            <input type="text" id="storeName" required>
                        </div>
                        <div class="input-row">
                            <div class="form-group">
                                <label>領収書発行元</label>
                                <input type="text" id="companyName">
                            </div>
                            <div class="form-group">
                                <label>電話番号</label>
                                <input type="text" id="phone">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>所在地</label>
                            <input type="text" id="address">
                        </div>

                        <div class="section-title" style="margin-top:30px;">営業設定</div>
                        <div class="input-row">
                            <div class="form-group">
                                <label>日付変更時間 (締め時間)</label>
                                <select id="closingHour">
                                    <option value="0">0:00</option>
                                    <option value="1">1:00</option>
                                    <option value="2">2:00</option>
                                    <option value="3">3:00</option>
                                    <option value="4">4:00</option>
                                    <option value="5">5:00</option>
                                    <option value="6">6:00 (推奨)</option>
                                    <option value="7">7:00</option>
                                    <option value="8">8:00</option>
                                    <option value="9">9:00</option>
                                    <option value="10">10:00</option>
                                    <option value="11">11:00</option>
                                    <option value="12">12:00</option>
                                    <option value="13">13:00</option>
                                    <option value="14">14:00</option>
                                    <option value="15">15:00</option>
                                    <option value="16">16:00</option>
                                    <option value="17">17:00</option>
                                    <option value="18">18:00</option>
                                    <option value="19">19:00</option>
                                    <option value="20">20:00</option>
                                    <option value="21">21:00</option>
                                    <option value="22">22:00</option>
                                    <option value="23">23:00</option>
                                </select>
                                <p class="helper-text">この時間を過ぎると「翌営業日」として扱われます。<br>（例：締め時間14:00の場合、13:59までの売上は前日扱い）</p>
                            </div>
                            <div class="form-group">
                                <label>定休日設定 (自動反映用)</label>
                                <div class="week-selector">
                                    <label><input type="checkbox" class="week-chk" value="1"><span class="week-label">月</span></label>
                                    <label><input type="checkbox" class="week-chk" value="2"><span class="week-label">火</span></label>
                                    <label><input type="checkbox" class="week-chk" value="3"><span class="week-label">水</span></label>
                                    <label><input type="checkbox" class="week-chk" value="4"><span class="week-label">木</span></label>
                                    <label><input type="checkbox" class="week-chk" value="5"><span class="week-label">金</span></label>
                                    <label><input type="checkbox" class="week-chk" value="6"><span class="week-label">土</span></label>
                                    <label><input type="checkbox" class="week-chk" value="0"><span class="week-label">日</span></label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="tab-accounting" class="settings-section">
                        <div class="section-title">会計・税率設定</div>
                        <div class="input-row">
                            <div class="form-group">
                                <label>消費税率 (%)</label>
                                <input type="number" id="taxRate" value="10">
                            </div>
                            <div class="form-group">
                                <label>サービス料率 (%)</label>
                                <input type="number" id="serviceRate" value="30">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>端数処理設定</label>
                            <select id="rounding">
                                <option value="none">何もしない</option>
                                <option value="up_10">10円単位で切り上げ</option>
                                <option value="down_10">10円単位で切り捨て</option>
                                <option value="up_100">100円単位で切り上げ</option>
                                <option value="down_100">100円単位で切り捨て</option>
                            </select>
                        </div>

                        <div class="section-title" style="margin-top:30px;">初回・指名制限設定</div>
                        <div class="input-row">
                            <div class="form-group">
                                <label>写真指名 上限人数</label>
                                <input type="number" id="shokaiPhoto" value="2">
                            </div>
                            <div class="form-group">
                                <label>送り指名 上限人数</label>
                                <input type="number" id="shokaiOkuri" value="1">
                            </div>
                        </div>
                    </div>

                    <div id="tab-salary" class="settings-section">
                        <div class="section-title">給与システム設定</div>
                        
                        <div class="input-row">
                            <div class="form-group">
                                <label>基本給タイプ</label>
                                <select id="salary-base-type">
                                    <option value="daily">日給制 (出勤日数 × 日給)</option>
                                    <option value="hourly">時給制 (労働時間 × 時給)</option>
                                    <option value="none">完全歩合制 (基本給なし)</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>売掛の扱い (バック計算基準)</label>
                                <select id="salary-credit-system">
                                    <option value="sales_base">売上ベース (未収も売上として計算)</option>
                                    <option value="payment_base">入金ベース (回収額のみ計算)</option>
                                </select>
                                <p class="helper-text">※「売上ベース」の場合、未回収金は通常給与から天引きされます。</p>
                            </div>
                        </div>

                        <div class="input-row">
                            <div class="form-group">
                                <label>源泉徴収税率 (%)</label>
                                <input type="number" id="salary-tax-rate" value="10.21" step="0.01">
                            </div>
                            <div class="form-group">
                                <label>厚生費 (月額固定)</label>
                                <input type="number" id="salary-welfare" value="10000">
                            </div>
                        </div>

                        <div class="form-group">
                            <label>売上バック率 (スライド設定)</label>
                            <p class="helper-text">売上金額に応じてバック率を変える場合の設定です。<br>例: 0円〜40%, 100万円〜50%</p>
                            
                            <div style="display:grid; grid-template-columns: 1fr 1fr 50px; gap:10px; font-weight:bold; margin-bottom:5px; font-size:0.9rem; color:#666;">
                                <span>最低売上額 (円以上)</span>
                                <span>バック率 (%)</span>
                                <span></span>
                            </div>
                            <div id="slide-container"></div>
                            <button type="button" class="btn-add" onclick="addSlideRow()">+ スライド行を追加</button>
                        </div>
                    </div>

                    <div id="tab-call" class="settings-section">
                        <div class="section-title">シャンパンコール設定</div>
                        <p class="helper-text">金額に応じたコールのグレードと演出内容を設定します。</p>
                        
                        <div style="margin-bottom:5px; font-weight:bold; font-size:0.9rem; display:grid; grid-template-columns:150px 150px 60px 1fr 40px; gap:10px; color:#666;">
                            <span>グレード名</span>
                            <span>最低金額 (¥)</span>
                            <span>色</span>
                            <span>楽曲リスト (カンマ区切り)</span>
                            <span></span>
                        </div>

                        <div id="call-grades-container"></div>
                        <button type="button" class="btn-add" onclick="addGradeRow()">+ グレード行を追加</button>
                    </div>

                </div>

                <div class="save-area">
                    <div id="status-msg" style="margin-right: 15px; font-weight: bold; color: #28a745;"></div>
                    <button type="submit" class="btn-primary" style="width: 200px; padding:15px;">全設定を保存する</button>
                </div>
            </form>
        </div>
    </div>

    <script type="module">
        import { db } from '../assets/js/firebase-config.js';
        import { doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        const tenantId = sessionStorage.getItem('hospos_tenantId');
        if (!tenantId) window.location.href = "../index.html";

        // タブ切り替え関数
        window.switchTab = (tabName) => {
            // ボタンのアクティブ化
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.tab-btn').classList.add('active');

            // コンテンツの切り替え
            document.querySelectorAll('.settings-section').forEach(sec => sec.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).classList.add('active');
        };

        // コンテナ
        const callContainer = document.getElementById('call-grades-container');
        const slideContainer = document.getElementById('slide-container');

        // 行追加関数
        window.addGradeRow = (name="", th=0, col="#000", sng="") => {
            const div = document.createElement('div');
            div.className = 'list-row';
            div.innerHTML = `
                <input type="text" class="grade-name" placeholder="名称" value="${name}" style="flex:1">
                <input type="number" class="grade-threshold" placeholder="金額" value="${th}" style="width:100px">
                <input type="color" class="grade-color" value="${col}" style="width:40px; height:40px; padding:0; cursor:pointer;">
                <input type="text" class="grade-songs" placeholder="曲リスト" value="${sng}" style="flex:2">
                <button type="button" class="btn-delete" onclick="this.parentElement.remove()"><i class="fas fa-trash"></i></button>
            `;
            callContainer.appendChild(div);
        };

        window.addSlideRow = (min=0, rate=40) => {
            const div = document.createElement('div');
            div.className = 'list-row';
            div.style.display = 'grid';
            div.style.gridTemplateColumns = '1fr 1fr 50px';
            div.innerHTML = `
                <input type="number" class="slide-min" placeholder="0" value="${min}">
                <input type="number" class="slide-rate" placeholder="40" value="${rate}">
                <button type="button" class="btn-delete" onclick="this.parentElement.remove()"><i class="fas fa-trash"></i></button>
            `;
            slideContainer.appendChild(div);
        };

        // ロード
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const docSnap = await getDoc(doc(db, "tenants", tenantId));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    const conf = data.config || {};

                    // 基本
                    document.getElementById('storeName').value = data.name || "";
                    document.getElementById('companyName').value = data.companyName || "";
                    document.getElementById('phone').value = data.phone || "";
                    document.getElementById('address').value = data.address || "";
                    
                    // 会計・営業
                    document.getElementById('taxRate').value = conf.taxRate ?? 10;
                    document.getElementById('serviceRate').value = conf.serviceRate ?? 30;
                    document.getElementById('rounding').value = conf.rounding || "up_10";
                    document.getElementById('shokaiPhoto').value = conf.shokaiLimit?.photo ?? 2;
                    document.getElementById('shokaiOkuri').value = conf.shokaiLimit?.okuri ?? 1;

                    if(conf.businessDay) {
                        document.getElementById('closingHour').value = conf.businessDay.cutoffHour ?? 6;
                        (conf.businessDay.holidays || []).forEach(d => {
                            const chk = document.querySelector(`.week-chk[value="${d}"]`);
                            if(chk) chk.checked = true;
                        });
                    }

                    // 給与設定
                    const salary = conf.salary || {};
                    document.getElementById('salary-base-type').value = salary.basePayType || 'daily';
                    document.getElementById('salary-credit-system').value = salary.creditSystem || 'sales_base';
                    document.getElementById('salary-tax-rate').value = salary.taxRate ?? 10.21;
                    document.getElementById('salary-welfare').value = salary.welfareFee ?? 10000;

                    if(salary.commissionSlide && salary.commissionSlide.length > 0) {
                        salary.commissionSlide.sort((a,b)=>a.minSales - b.minSales).forEach(s => addSlideRow(s.minSales, s.rate));
                    } else {
                        addSlideRow(0, 40);
                    }

                    // コール設定
                    (conf.callGrades || []).forEach(g => addGradeRow(g.name, g.threshold, g.color, g.songs));
                }
            } catch(e) { console.error(e); }
        });

        // 保存
        document.getElementById('settings-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const statusMsg = document.getElementById('status-msg');
            statusMsg.textContent = "保存中...";

            // データ収集
            const callGrades = [];
            document.querySelectorAll('#call-grades-container .list-row').forEach(row => {
                callGrades.push({
                    name: row.querySelector('.grade-name').value,
                    threshold: Number(row.querySelector('.grade-threshold').value),
                    color: row.querySelector('.grade-color').value,
                    songs: row.querySelector('.grade-songs').value
                });
            });

            const commissionSlide = [];
            document.querySelectorAll('#slide-container .list-row').forEach(row => {
                commissionSlide.push({
                    minSales: Number(row.querySelector('.slide-min').value),
                    rate: Number(row.querySelector('.slide-rate').value)
                });
            });

            const holidays = [];
            document.querySelectorAll('.week-chk:checked').forEach(chk => holidays.push(Number(chk.value)));

            const updateData = {
                name: document.getElementById('storeName').value,
                companyName: document.getElementById('companyName').value,
                address: document.getElementById('address').value,
                phone: document.getElementById('phone').value,
                config: {
                    taxRate: Number(document.getElementById('taxRate').value),
                    serviceRate: Number(document.getElementById('serviceRate').value),
                    rounding: document.getElementById('rounding').value,
                    shokaiLimit: {
                        photo: Number(document.getElementById('shokaiPhoto').value),
                        okuri: Number(document.getElementById('shokaiOkuri').value)
                    },
                    callGrades: callGrades,
                    businessDay: {
                        cutoffHour: Number(document.getElementById('closingHour').value),
                        holidays: holidays
                    },
                    salary: {
                        basePayType: document.getElementById('salary-base-type').value,
                        creditSystem: document.getElementById('salary-credit-system').value,
                        taxRate: Number(document.getElementById('salary-tax-rate').value),
                        welfareFee: Number(document.getElementById('salary-welfare').value),
                        commissionSlide: commissionSlide
                    }
                }
            };

            try {
                await updateDoc(doc(db, "tenants", tenantId), updateData);
                statusMsg.textContent = "保存完了しました！";
                setTimeout(() => statusMsg.textContent = "", 3000);
            } catch(e) { console.error(e); statusMsg.textContent = "エラーが発生しました"; statusMsg.style.color = "red"; }
        });
    </script>
</body>
</html>