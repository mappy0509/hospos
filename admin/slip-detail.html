<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOSPOS - 伝票詳細・会計</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 画面レイアウト */
        .dashboard-container { display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background-color: #fff; border-right: 1px solid var(--border-color); padding: 20px; display: flex; flex-direction: column; }
        .main-content { flex: 1; padding: 30px; background-color: var(--bg-color); display: flex; gap: 20px; }
        
        /* 左側：注文リスト */
        .order-section { flex: 2; background: white; border-radius: 12px; padding: 20px; box-shadow: var(--shadow-sm); display: flex; flex-direction: column; }
        .order-list { flex: 1; overflow-y: auto; border: 1px solid #eee; border-radius: 8px; margin-top: 15px; }
        .order-item { display: grid; grid-template-columns: 2fr 1fr 1fr 1fr; padding: 12px; border-bottom: 1px solid #eee; align-items: center; }
        .order-header { background: #f8f9fa; font-weight: bold; color: #666; position: sticky; top: 0; }
        
        /* 右側：会計パネル */
        .payment-section { flex: 1.2; background: white; border-radius: 12px; padding: 25px; box-shadow: var(--shadow-sm); height: fit-content; position: sticky; top: 30px; }
        .calc-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; }
        .calc-total-box { background: #f8f9fa; padding: 15px; border-radius: 8px; margin: 15px 0; text-align: right; border: 2px solid #e9ecef; }
        .total-label { font-size: 0.9rem; color: #666; display: block; }
        .total-amount { font-size: 2rem; font-weight: bold; color: var(--text-main); line-height: 1.2; }
        .payment-inputs { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 20px; }
        .pay-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px; }
        .pay-row label { font-weight: bold; width: 100px; }
        .pay-input { flex: 1; padding: 10px; font-size: 1.1rem; text-align: right; border: 1px solid #ccc; border-radius: 6px; }
        .result-box { padding: 15px; border-radius: 8px; text-align: center; margin-bottom: 20px; font-weight: bold; font-size: 1.2rem; display: none; }
        .result-change { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .result-debt { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .btn-checkout { width: 100%; padding: 15px; font-size: 1.1rem; margin-top: 10px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-checkout:disabled { background: #ccc; cursor: not-allowed; }
        .action-buttons { display: flex; gap: 10px; margin-top: 15px; }
        .btn-sub { flex: 1; padding: 10px; border: 1px solid #ddd; background: white; border-radius: 6px; cursor: pointer; font-weight: bold; color: #555; }
        .btn-add-order { width: 100%; padding: 10px; background: #e6f2ff; color: var(--primary-color); border: 1px dashed var(--primary-color); border-radius: 8px; margin-top: 10px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-add-order:hover { background: #cce5ff; }

        /* モーダル系 */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 500px; max-width: 95%; max-height: 80vh; overflow-y: auto; box-shadow: var(--shadow-lg); }
        .prod-select-list { display: flex; flex-direction: column; gap: 10px; margin-top: 15px; }
        .prod-option { padding: 10px; border: 1px solid #eee; border-radius: 6px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .prod-option:hover { background: #f8f9fa; }
        .prod-option.selected { border-color: var(--primary-color); background: #e6f2ff; }

        @media print {
            body * { visibility: hidden; }
            #receipt-area, #receipt-area * { visibility: visible; }
            #receipt-area { position: absolute; left: 0; top: 0; width: 80mm; display: block; }
        }
        #receipt-area { display: none; background: #fff; width: 300px; padding: 20px; }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 5px; }
    </style>
</head>
<body>

    <div class="dashboard-container">
        <div class="sidebar no-print">
            <div class="brand"><i class="fas fa-glass-cheers"></i> HOSPOS</div>
            <button onclick="window.location.href='dashboard.html'" class="btn-sub" style="width:100%; margin-bottom:20px; background:#6c757d; color:white;">
                <i class="fas fa-arrow-left"></i> ダッシュボードへ
            </button>
        </div>

        <div class="main-content">
            <div class="order-section">
                <h2 id="table-title">Table: ...</h2>
                <p id="customer-name" style="color:#666; margin-bottom:10px;">...</p>
                
                <div class="order-item order-header">
                    <div>商品名</div>
                    <div>単価</div>
                    <div>数量</div>
                    <div>小計</div>
                </div>
                <div id="order-list-container" class="order-list"></div>
                
                <button class="btn-add-order" onclick="openAddOrderModal()">
                    <i class="fas fa-plus-circle"></i> 商品を追加する (内勤用)
                </button>
            </div>

            <div class="payment-section">
                <h3><i class="fas fa-cash-register"></i> お会計・レジ</h3>
                
                <div style="margin-top:15px; color:#555;">
                    <div class="calc-row"><span>商品小計</span> <span id="calc-subtotal">¥0</span></div>
                    <div class="calc-row"><span>サービス料 (<span id="rate-service">0</span>%)</span> <span id="calc-service">¥0</span></div>
                    <div class="calc-row"><span>消費税 (<span id="rate-tax">0</span>%)</span> <span id="calc-tax">¥0</span></div>
                    <div class="calc-row"><span>端数調整</span> <span id="calc-rounding">¥0</span></div>
                </div>

                <div class="calc-total-box">
                    <span class="total-label">ご請求金額 (税込)</span>
                    <div class="total-amount" id="calc-grand-total">¥0</div>
                </div>

                <div class="payment-inputs">
                    <div class="pay-row"><label>現金</label><input type="number" id="pay-cash" class="pay-input" placeholder="0" min="0"></div>
                    <div class="pay-row"><label>カード</label><input type="number" id="pay-card" class="pay-input" placeholder="0" min="0"></div>
                    <div class="pay-row" style="border-top:1px dashed #ddd; padding-top:10px; margin-top:10px;">
                        <label style="color:#dc3545;">売掛予定</label>
                        <span id="pay-credit" style="flex:1; text-align:right; font-weight:bold; color:#dc3545; font-size:1.1rem;">¥0</span>
                    </div>
                </div>

                <div id="result-change" class="result-box result-change">お釣り: <span id="val-change">¥0</span></div>
                <div id="result-debt" class="result-box result-debt">不足 (売掛): <span id="val-debt">¥0</span></div>

                <button id="btn-checkout" class="btn-checkout" disabled>金額を入力してください</button>
                
                <div class="action-buttons">
                    <button id="btn-receipt" class="btn-sub"><i class="fas fa-print"></i> 印刷</button>
                    <button id="btn-void" class="btn-sub" style="color:#dc3545;"><i class="fas fa-ban"></i> 没電</button>
                </div>
            </div>
        </div>
    </div>

    <div id="add-order-modal" class="modal-overlay">
        <div class="modal-content">
            <h3>商品追加</h3>
            <input type="text" id="prod-search" placeholder="商品名で検索..." style="width:100%; padding:10px; margin-bottom:10px; border:1px solid #ddd; border-radius:6px;">
            <div id="prod-list" class="prod-select-list">読み込み中...</div>
            
            <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
                <label style="font-weight:bold;">数量: </label>
                <input type="number" id="new-order-qty" value="1" min="1" style="width:60px; padding:5px; text-align:center;">
                <span id="selected-prod-name" style="margin-left:10px; font-weight:bold; color:var(--primary-color);"></span>
            </div>

            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-checkout" id="do-add-btn" disabled onclick="submitNewOrder()">追加する</button>
                <button class="btn-sub" onclick="document.getElementById('add-order-modal').style.display='none'">閉じる</button>
            </div>
        </div>
    </div>

    <div id="receipt-area">
        <div style="text-align:center; font-weight:bold; margin-bottom:10px;" id="rec-store-name"></div>
        <div style="font-size:0.8rem; border-bottom:1px dashed #000; margin-bottom:10px;">
            Date: <span id="rec-date"></span><br>Table: <span id="rec-table"></span>
        </div>
        <div id="rec-items"></div>
        <div style="border-top:1px dashed #000; margin:10px 0;"></div>
        <div class="receipt-row" style="font-weight:bold;"><span>TOTAL</span> <span id="rec-total"></span></div>
        <div class="receipt-row"><span>Cash</span> <span id="rec-cash"></span></div>
        <div class="receipt-row"><span>Card</span> <span id="rec-card"></span></div>
        <div class="receipt-row"><span>Credit</span> <span id="rec-debt"></span></div>
        <div class="receipt-row" style="margin-top:5px; font-weight:bold;"><span>Change</span> <span id="rec-change"></span></div>
    </div>

    <script type="module">
        import { db } from '../assets/js/firebase-config.js';
        import { doc, getDoc, collection, getDocs, updateDoc, addDoc, serverTimestamp, increment, writeBatch } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";

        const tenantId = sessionStorage.getItem('hospos_tenantId');
        const params = new URLSearchParams(window.location.search);
        let slipId = params.get('id');
        if(!slipId) { slipId = prompt("伝票IDを入力してください"); if(!slipId) window.location.href="dashboard.html"; }

        let config = { tax: 10, service: 30, rounding: 'up_10' };
        let slipData = null;
        let tenantInfo = {};
        let currentOrders = [];
        let allProducts = [];
        let selectedProduct = null;
        let calcResult = { grandTotal: 0 };

        // UI Elements
        const inputCash = document.getElementById('pay-cash');
        const inputCard = document.getElementById('pay-card');
        const displayCredit = document.getElementById('pay-credit');
        const resultChange = document.getElementById('result-change');
        const resultDebt = document.getElementById('result-debt');
        const btnCheckout = document.getElementById('btn-checkout');

        async function init() {
            const tSnap = await getDoc(doc(db, "tenants", tenantId));
            if(tSnap.exists()) {
                tenantInfo = tSnap.data();
                if(tenantInfo.config) {
                    config.tax = tenantInfo.config.taxRate ?? 10;
                    config.service = tenantInfo.config.serviceRate ?? 30;
                    config.rounding = tenantInfo.config.rounding || 'up_10';
                }
                document.getElementById('rate-service').textContent = config.service;
                document.getElementById('rate-tax').textContent = config.tax;
            }
            loadSlip();
            loadProducts(); // 商品マスタ読み込み
        }

        async function loadSlip() {
            const sRef = doc(db, "tenants", tenantId, "slips", slipId);
            const sSnap = await getDoc(sRef);
            if(!sSnap.exists()) { alert("Error: Slip not found"); return; }
            slipData = sSnap.data();

            document.getElementById('table-title').textContent = `Table: ${slipData.tableId}`;
            document.getElementById('customer-name').textContent = slipData.customerName;

            const oSnap = await getDocs(collection(sRef, "orders"));
            currentOrders = [];
            oSnap.forEach(d => currentOrders.push(d.data()));
            renderOrders();
            calculateBill();
        }

        function renderOrders() {
            const container = document.getElementById('order-list-container');
            container.innerHTML = "";
            currentOrders.forEach(o => {
                const sub = o.price * o.quantity;
                container.innerHTML += `<div class="order-item"><div>${o.name}</div><div>¥${o.price.toLocaleString()}</div><div>x${o.quantity}</div><div style="font-weight:bold;">¥${sub.toLocaleString()}</div></div>`;
            });
        }

        // 商品リスト読み込み
        async function loadProducts() {
            const q = collection(db, "tenants", tenantId, "products");
            const snap = await getDocs(q);
            allProducts = [];
            snap.forEach(doc => allProducts.push({ id: doc.id, ...doc.data() }));
        }

        // モーダル表示・商品検索
        window.openAddOrderModal = () => {
            document.getElementById('add-order-modal').style.display = 'flex';
            renderProductList("");
        };

        document.getElementById('prod-search').addEventListener('input', (e) => renderProductList(e.target.value));

        function renderProductList(term) {
            const container = document.getElementById('prod-list');
            container.innerHTML = "";
            const filtered = allProducts.filter(p => p.name.toLowerCase().includes(term.toLowerCase()));
            
            filtered.forEach(p => {
                const div = document.createElement('div');
                div.className = "prod-option";
                div.innerHTML = `<span>${p.name}</span><span style="font-weight:bold;">¥${Number(p.price).toLocaleString()}</span>`;
                div.onclick = () => selectProduct(p, div);
                container.appendChild(div);
            });
        }

        function selectProduct(prod, el) {
            selectedProduct = prod;
            document.querySelectorAll('.prod-option').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('selected-prod-name').textContent = prod.name;
            document.getElementById('do-add-btn').disabled = false;
        }

        // 注文追加実行
        window.submitNewOrder = async () => {
            if(!selectedProduct) return;
            const qty = Number(document.getElementById('new-order-qty').value);
            if(qty < 1) return;

            const btn = document.getElementById('do-add-btn');
            btn.disabled = true; btn.textContent = "処理中...";

            try {
                const batch = writeBatch(db);
                const slipRef = doc(db, "tenants", tenantId, "slips", slipId);
                const newOrderRef = doc(collection(db, "tenants", tenantId, "slips", slipId, "orders"));
                
                const lineTotal = selectedProduct.price * qty;
                const callAdd = selectedProduct.isCallTarget ? lineTotal : 0;

                batch.set(newOrderRef, {
                    name: selectedProduct.name,
                    price: Number(selectedProduct.price),
                    quantity: qty,
                    productId: selectedProduct.id,
                    orderedBy: 'admin', // 内勤追加
                    status: 'served',
                    createdAt: serverTimestamp(),
                    isCallTarget: selectedProduct.isCallTarget || false
                });

                batch.update(slipRef, {
                    totalAmount: increment(lineTotal),
                    callBatchAmount: increment(callAdd),
                    lastUpdated: serverTimestamp()
                });

                await batch.commit();
                
                document.getElementById('add-order-modal').style.display = 'none';
                btn.textContent = "追加する";
                loadSlip(); // 再読み込み
            } catch(e) {
                console.error(e); alert("追加エラー"); btn.disabled = false;
            }
        };

        // 計算ロジック
        function calculateBill() {
            let subtotal = 0;
            currentOrders.forEach(o => subtotal += (o.price * o.quantity));
            let serviceFee = Math.floor(subtotal * (config.service / 100));
            let taxable = subtotal + serviceFee;
            let tax = Math.floor(taxable * (config.tax / 100));
            let rawTotal = taxable + tax;
            let total = rawTotal;
            if (config.rounding === 'up_10') total = Math.ceil(rawTotal / 10) * 10;
            
            document.getElementById('calc-subtotal').textContent = `¥${subtotal.toLocaleString()}`;
            document.getElementById('calc-service').textContent = `¥${serviceFee.toLocaleString()}`;
            document.getElementById('calc-tax').textContent = `¥${tax.toLocaleString()}`;
            document.getElementById('calc-rounding').textContent = `¥${total - rawTotal}`;
            document.getElementById('calc-grand-total').textContent = `¥${total.toLocaleString()}`;
            calcResult = { subtotal, serviceFee, tax, grandTotal: total };
            updatePaymentCalc();
        }

        function updatePaymentCalc() {
            const cash = Number(inputCash.value) || 0;
            const card = Number(inputCard.value) || 0;
            const totalPaid = cash + card;
            const diff = totalPaid - calcResult.grandTotal;

            resultChange.style.display = 'none'; resultDebt.style.display = 'none';
            displayCredit.textContent = "¥0"; btnCheckout.disabled = false;

            if (diff >= 0) {
                resultChange.style.display = 'block';
                document.getElementById('val-change').textContent = `¥${diff.toLocaleString()}`;
                btnCheckout.textContent = "会計を確定する";
                btnCheckout.style.background = "#28a745";
                calcResult.change = diff; calcResult.debt = 0;
            } else {
                const debt = Math.abs(diff);
                resultDebt.style.display = 'block';
                document.getElementById('val-debt').textContent = `¥${debt.toLocaleString()}`;
                displayCredit.textContent = `¥${debt.toLocaleString()}`;
                btnCheckout.textContent = "売掛を含んで会計確定";
                btnCheckout.style.background = "#dc3545";
                calcResult.change = 0; calcResult.debt = debt;
            }
        }

        inputCash.addEventListener('input', updatePaymentCalc);
        inputCard.addEventListener('input', updatePaymentCalc);

        btnCheckout.onclick = async () => {
            if(!confirm("会計を確定しますか？")) return;
            const cash = Number(inputCash.value) || 0;
            const card = Number(inputCard.value) || 0;
            try {
                await updateDoc(doc(db, "tenants", tenantId, "slips", slipId), {
                    status: 'paid',
                    totalAmount: calcResult.grandTotal,
                    paidAt: serverTimestamp(),
                    paymentDetails: { cash, card, credit: calcResult.debt, change: calcResult.change },
                    hasDebt: calcResult.debt > 0,
                    debtAmount: calcResult.debt
                });
                alert("会計完了"); window.location.href = "dashboard.html";
            } catch(e) { alert("Error: " + e.message); }
        };

        document.getElementById('btn-receipt').onclick = () => {
            document.getElementById('rec-store-name').textContent = tenantInfo.name || "CLUB HOSPOS";
            document.getElementById('rec-date').textContent = new Date().toLocaleString();
            document.getElementById('rec-table').textContent = slipData.tableId;
            document.getElementById('rec-items').innerHTML = currentOrders.map(o => `<div class="receipt-row"><span>${o.name}</span><span>¥${(o.price * o.quantity).toLocaleString()}</span></div>`).join("");
            document.getElementById('rec-total').textContent = `¥${calcResult.grandTotal.toLocaleString()}`;
            document.getElementById('rec-cash').textContent = `¥${(Number(inputCash.value)||0).toLocaleString()}`;
            document.getElementById('rec-card').textContent = `¥${(Number(inputCard.value)||0).toLocaleString()}`;
            document.getElementById('rec-debt').textContent = `¥${calcResult.debt.toLocaleString()}`;
            document.getElementById('rec-change').textContent = `¥${calcResult.change.toLocaleString()}`;
            window.print();
        };

        init();
    </script>
</body>
</html>