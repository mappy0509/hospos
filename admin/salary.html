<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HOSPOS - 給与管理</title>
    <link rel="stylesheet" href="../assets/css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 共通レイアウト */
        .dashboard-container { display: flex; min-height: 100vh; }
        .sidebar { width: 250px; background-color: #fff; border-right: 1px solid var(--border-color); padding: 20px; display: flex; flex-direction: column; }
        .main-content { flex: 1; padding: 30px; background-color: var(--bg-color); }
        .menu-item { padding: 12px; color: var(--text-main); text-decoration: none; display: flex; align-items: center; gap: 10px; border-radius: 8px; margin-bottom: 5px; transition: 0.2s; }
        .menu-item:hover, .menu-item.active { background-color: #e6f2ff; color: var(--primary-color); }
        .brand { font-size: 1.5rem; font-weight: bold; color: var(--primary-color); margin-bottom: 40px; display: flex; align-items: center; gap: 10px; }

        /* コントロールエリア */
        .control-panel { background: white; padding: 20px; border-radius: 12px; box-shadow: var(--shadow-sm); display: flex; gap: 15px; align-items: flex-end; margin-bottom: 20px; flex-wrap: wrap; }
        .form-group { margin: 0; min-width: 150px; }
        .form-group label { display: block; font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; }
        .input-box { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; }
        .btn-calc { padding: 10px 20px; background: var(--primary-color); color: white; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; height: 42px; }

        /* 計算結果エリア (給与明細風) */
        .salary-sheet { background: white; padding: 30px; border-radius: 12px; box-shadow: var(--shadow-sm); display: none; }
        .sheet-header { border-bottom: 2px solid #f0f0f0; padding-bottom: 10px; margin-bottom: 20px; font-weight: bold; font-size: 1.2rem; color: #333; display: flex; flex-wrap: wrap; gap: 10px; align-items: center; }
        
        .grid-row { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .detail-box { border: 1px solid #eee; border-radius: 8px; padding: 15px; }
        .detail-title { font-weight: bold; margin-bottom: 10px; color: #666; font-size: 0.9rem; text-align: center; background: #f9f9f9; padding: 5px; border-radius: 4px; }
        
        .line-item { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; align-items: center; }
        .line-item input { text-align: right; width: 100px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; }
        .line-item span { font-weight: bold; }

        .total-row { margin-top: 20px; padding-top: 20px; border-top: 2px solid #333; display: flex; justify-content: flex-end; font-size: 1.5rem; font-weight: bold; color: var(--primary-color); }
        
        .action-area { margin-top: 30px; display: flex; justify-content: flex-end; gap: 10px; align-items: center; flex-wrap: wrap; }
        .btn-save { background: #28a745; color: white; padding: 12px 30px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 1rem; }

        /* Mobile Header & Layout */
        .admin-mobile-header { display: none; background: white; padding: 15px; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow-sm); }
        .mobile-menu-btn { background: none; border: none; font-size: 1.5rem; }

        @media (max-width: 768px) {
            .dashboard-container { flex-direction: column; }
            .sidebar { display: none; width: 100%; position: fixed; top: 60px; left: 0; height: calc(100vh - 60px); z-index: 99; overflow-y: auto; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
            .sidebar.active { display: flex; }
            .admin-mobile-header { display: flex; }
            .main-content { padding: 20px; }
            
            /* コントロールパネル調整 */
            .control-panel { flex-direction: column; align-items: stretch; gap: 15px; }
            .form-group { width: 100%; }
            .btn-calc { width: 100%; }

            /* 給与明細グリッドを1列に */
            .grid-row { grid-template-columns: 1fr; gap: 15px; }
            .salary-sheet { padding: 20px; }
            .total-row { font-size: 1.3rem; }
            .action-area { flex-direction: column; align-items: stretch; }
            .btn-save { width: 100%; }
            #save-msg { text-align: center; margin-bottom: 10px; }
        }
    </style>
</head>
<body>

    <div class="admin-mobile-header">
        <div style="font-weight:bold; font-size:1.2rem; color:var(--primary-color);"><i class="fas fa-glass-cheers"></i> HOSPOS</div>
        <button class="mobile-menu-btn" id="mobile-menu-toggle"><i class="fas fa-bars"></i></button>
    </div>

    <div class="dashboard-container">
        <div class="sidebar" id="sidebar">
            <div class="brand"><i class="fas fa-glass-cheers"></i> HOSPOS</div>
            <nav>
                <a href="dashboard.html" class="menu-item"><i class="fas fa-tachometer-alt"></i> ダッシュボード</a>
                <a href="schedule.html" class="menu-item"><i class="fas fa-calendar-alt"></i> スケジュール</a>
                <a href="slips.html" class="menu-item"><i class="fas fa-file-invoice-dollar"></i> 伝票一覧</a>
                <a href="call-management.html" class="menu-item"><i class="fas fa-music"></i> コール管理</a>
                <a href="shokai-control.html" class="menu-item"><i class="fas fa-users"></i> 初回・付け回し</a>
                <a href="products.html" class="menu-item"><i class="fas fa-wine-bottle"></i> 商品管理</a>
                <a href="inventory.html" class="menu-item"><i class="fas fa-boxes"></i> 在庫管理</a>
                <a href="cast-list.html" class="menu-item"><i class="fas fa-user-tie"></i> キャスト管理</a>
                <a href="attendance.html" class="menu-item"><i class="fas fa-clock"></i> 出勤管理</a>
                <a href="salary.html" class="menu-item active"><i class="fas fa-money-bill-wave"></i> 給与管理</a>
                <a href="customers.html" class="menu-item"><i class="fas fa-address-book"></i> 顧客管理</a>
                <a href="sales-analysis.html" class="menu-item"><i class="fas fa-chart-line"></i> 売上分析</a>
                <a href="ranking.html" class="menu-item"><i class="fas fa-trophy"></i> ランキング</a>
                <a href="daily-report.html" class="menu-item"><i class="fas fa-file-alt"></i> 日報・ログ</a>
                <a href="settings.html" class="menu-item"><i class="fas fa-cog"></i> 店舗設定</a>
            </nav>
        </div>

        <div class="main-content">
            <h2 style="margin-bottom: 20px;"><i class="fas fa-money-bill-wave"></i> 給与・報酬管理</h2>

            <div class="control-panel">
                <div class="form-group">
                    <label>対象月</label>
                    <input type="month" id="target-month" class="input-box">
                </div>
                <div class="form-group">
                    <label>キャスト選択</label>
                    <select id="cast-select" class="input-box">
                        <option value="">選択してください</option>
                    </select>
                </div>
                <button class="btn-calc" onclick="calculateSalary()"><i class="fas fa-calculator"></i> 計算する</button>
            </div>

            <div id="salary-sheet" class="salary-sheet">
                <div class="sheet-header">
                    <span id="sheet-title">2023年10月分 給与明細</span>
                    <span style="font-size:0.8rem; color:#666; margin-left:auto;">※各項目は手動で修正可能です</span>
                </div>

                <div class="grid-row">
                    <div class="detail-box">
                        <div class="detail-title">支給項目</div>
                        <div class="line-item">
                            <label>基本給</label>
                            <input type="number" id="val-base" oninput="updateTotal()">
                        </div>
                        <div class="line-item">
                            <label>歩合給</label>
                            <input type="number" id="val-commission" oninput="updateTotal()">
                        </div>
                        <div class="line-item">
                            <label>各種賞金</label>
                            <input type="number" id="val-prize" value="0" oninput="updateTotal()">
                        </div>
                        <div style="border-top:1px dashed #ccc; margin-top:5px; padding-top:5px;" class="line-item">
                            <label>支給計</label>
                            <span id="disp-gross">0</span>
                        </div>
                    </div>

                    <div class="detail-box" style="background:#f9f9f9;">
                        <div class="detail-title">売上実績 (参考)</div>
                        <div class="line-item">
                            <label>指名売上</label>
                            <span id="ref-sales">0</span>
                        </div>
                        <div class="line-item">
                            <label>バック率</label>
                            <span id="ref-rate">0%</span>
                        </div>
                        <div class="line-item">
                            <label>出勤日数</label>
                            <span id="ref-days">0日</span>
                        </div>
                        <div class="line-item" style="color:#dc3545;">
                            <label>未収売掛金</label>
                            <span id="ref-credit">0</span>
                        </div>
                    </div>

                    <div class="detail-box">
                        <div class="detail-title">控除項目</div>
                        <div class="line-item">
                            <label>源泉徴収税</label>
                            <input type="number" id="val-tax" oninput="updateTotal()">
                        </div>
                        <div class="line-item">
                            <label>厚生費</label>
                            <input type="number" id="val-welfare" oninput="updateTotal()">
                        </div>
                        <div class="line-item">
                            <label>売掛天引き</label>
                            <input type="number" id="val-credit-deduction" oninput="updateTotal()" style="color:#dc3545;">
                        </div>
                        <div class="line-item">
                            <label>その他罰金</label>
                            <input type="number" id="val-penalty" value="0" oninput="updateTotal()">
                        </div>
                        <div style="border-top:1px dashed #ccc; margin-top:5px; padding-top:5px;" class="line-item">
                            <label>控除計</label>
                            <span id="disp-deduction">0</span>
                        </div>
                    </div>
                </div>

                <div class="total-row">
                    差引支給額: ¥<span id="disp-total">0</span>
                </div>

                <div class="action-area">
                    <div id="save-msg" style="color:green; font-weight:bold; display:none; margin-right:10px;">保存しました</div>
                    <button class="btn-save" onclick="saveSalary()"><i class="fas fa-save"></i> 確定して保存</button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { db } from '../assets/js/firebase-config.js';
        import { collection, query, where, getDocs, doc, getDoc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-firestore.js";
        import { SalaryCalculator } from '../assets/js/salary-calculator.js';

        const tenantId = sessionStorage.getItem('hospos_tenantId');
        if (!tenantId) window.location.href = "../index.html";

        // Mobile Sidebar Toggle
        const toggleBtn = document.getElementById('mobile-menu-toggle');
        if(toggleBtn) {
            toggleBtn.onclick = () => {
                document.getElementById('sidebar').classList.toggle('active');
            };
        }

        const monthInput = document.getElementById('target-month');
        const castSelect = document.getElementById('cast-select');
        
        let config = {};
        let casts = [];

        // 初期化
        async function init() {
            // 今月をセット
            const now = new Date();
            const mStr = now.toISOString().slice(0, 7);
            monthInput.value = mStr;

            // 設定とキャスト一覧取得
            const [confSnap, castSnap] = await Promise.all([
                getDoc(doc(db, "tenants", tenantId)),
                getDocs(query(collection(db, "tenants", tenantId, "users"), where("role", "==", "cast")))
            ]);

            if(confSnap.exists()) {
                config = confSnap.data().config?.salary || {};
            }

            castSelect.innerHTML = '<option value="">選択してください</option>';
            castSnap.forEach(d => {
                const c = d.data();
                casts.push({ id: d.id, name: c.name, dailyWage: c.dailyWage || 10000 }); // 日給はユーザーデータに持たせる想定
                castSelect.innerHTML += `<option value="${d.id}">${c.name}</option>`;
            });
        }

        // 計算実行
        window.calculateSalary = async () => {
            const castId = castSelect.value;
            const monthStr = monthInput.value; // "2023-10"
            if(!castId || !monthStr) { alert("月とキャストを選択してください"); return; }

            const [year, month] = monthStr.split('-').map(Number);
            const startDate = new Date(year, month - 1, 1);
            const endDate = new Date(year, month, 0, 23, 59, 59);

            // 1. 勤怠データ取得
            const attQ = query(
                collection(db, "tenants", tenantId, "attendance"),
                where("userId", "==", castId),
                where("type", "==", "in"), 
                where("timestamp", ">=", startDate),
                where("timestamp", "<=", endDate)
            );
            const attSnap = await getDocs(attQ);
            const workDays = attSnap.size;

            // 2. 売上データ取得 (指名伝票のみ)
            const slipQ = query(
                collection(db, "tenants", tenantId, "slips"),
                where("primaryCastId", "==", castId),
                where("visitType", "==", "shime"),
                where("status", "==", "paid")
            );
            const slipSnap = await getDocs(slipQ);
            const targetSlips = [];
            
            slipSnap.forEach(d => {
                const data = d.data();
                const dDate = data.startTime.toDate();
                if(dDate >= startDate && dDate <= endDate) {
                    targetSlips.push(data);
                }
            });

            // 3. 計算
            const calculator = new SalaryCalculator(config);
            const castInfo = casts.find(c => c.id === castId);
            const res = calculator.calculate({ workDays }, targetSlips, { dailyWage: castInfo.dailyWage });

            // 4. 画面反映
            document.getElementById('sheet-title').textContent = `${year}年${month}月 ${castInfo.name}様 給与明細`;
            document.getElementById('salary-sheet').style.display = 'block';

            // 支給
            document.getElementById('val-base').value = res.basePay;
            document.getElementById('val-commission').value = res.commission;
            document.getElementById('val-prize').value = 0;

            // 参考
            document.getElementById('ref-sales').textContent = `¥${res.grossSales.toLocaleString()}`;
            document.getElementById('ref-rate').textContent = `${res.commissionRate}%`;
            document.getElementById('ref-days').textContent = `${workDays}日`;
            document.getElementById('ref-credit').textContent = `¥${res.unpaidCredit.toLocaleString()}`;

            // 控除
            document.getElementById('val-tax').value = res.tax;
            document.getElementById('val-welfare').value = res.welfare;
            document.getElementById('val-credit-deduction').value = res.creditDeduction;
            document.getElementById('val-penalty').value = 0;

            updateTotal();
        };

        // 合計再計算
        window.updateTotal = () => {
            const base = Number(document.getElementById('val-base').value) || 0;
            const comm = Number(document.getElementById('val-commission').value) || 0;
            const prize = Number(document.getElementById('val-prize').value) || 0;
            const gross = base + comm + prize;

            const tax = Number(document.getElementById('val-tax').value) || 0;
            const wel = Number(document.getElementById('val-welfare').value) || 0;
            const credit = Number(document.getElementById('val-credit-deduction').value) || 0;
            const pen = Number(document.getElementById('val-penalty').value) || 0;
            const ded = tax + wel + credit + pen;

            document.getElementById('disp-gross').textContent = `¥${gross.toLocaleString()}`;
            document.getElementById('disp-deduction').textContent = `¥${ded.toLocaleString()}`;
            document.getElementById('disp-total').textContent = (gross - ded).toLocaleString();
        };

        // 保存
        window.saveSalary = async () => {
            const castId = castSelect.value;
            const monthStr = monthInput.value;
            if(!castId) return;

            const data = {
                castId: castId,
                castName: casts.find(c => c.id === castId).name,
                targetMonth: monthStr,
                basePay: Number(document.getElementById('val-base').value),
                commission: Number(document.getElementById('val-commission').value),
                prize: Number(document.getElementById('val-prize').value),
                tax: Number(document.getElementById('val-tax').value),
                welfare: Number(document.getElementById('val-welfare').value),
                creditDeduction: Number(document.getElementById('val-credit-deduction').value),
                penalty: Number(document.getElementById('val-penalty').value),
                totalPayout: Number(document.getElementById('disp-total').textContent.replace(/,/g, '')),
                updatedAt: serverTimestamp()
            };

            try {
                const docId = `${monthStr}_${castId}`;
                await setDoc(doc(db, "tenants", tenantId, "salaries", docId), data);
                
                const msg = document.getElementById('save-msg');
                msg.style.display = 'inline';
                setTimeout(() => msg.style.display = 'none', 2000);
            } catch(e) {
                alert("保存エラー: " + e.message);
            }
        };

        init();
    </script>
</body>
</html>